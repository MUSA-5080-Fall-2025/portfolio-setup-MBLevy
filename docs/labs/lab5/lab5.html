<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.23">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matthew">
<meta name="dcterms.date" content="2025-12-01">

<title>Space-Time Prediction of Bike Share Demand: Philadelphia Indego – Matthew Levy - MUSA 5080 Portfolio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-1fe81d0376b2c50856e68e651e390326.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>

<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">



</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Matthew Levy - MUSA 5080 Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Weekly Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-weekly-notes">    
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-01-notes.html">
 <span class="dropdown-text">Week 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-02-notes.html">
 <span class="dropdown-text">Week 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-03-notes.html">
 <span class="dropdown-text">Week 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-04-notes.html">
 <span class="dropdown-text">Week 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-05-notes.html">
 <span class="dropdown-text">Week 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-06-notes.html">
 <span class="dropdown-text">Week 6</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-07-notes.html">
 <span class="dropdown-text">Week 7</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-09-notes.html">
 <span class="dropdown-text">Week 9</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-10-notes.html">
 <span class="dropdown-text">Week 10</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-11-notes.html">
 <span class="dropdown-text">Week 11</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-12-notes.html">
 <span class="dropdown-text">Week 12</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-labs" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Labs</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-labs">    
        <li>
    <a class="dropdown-item" href="../../labs/lab0/lab0_template.html">
 <span class="dropdown-text">Lab 0: dyplr Basics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab1/assignment1_template.html">
 <span class="dropdown-text">Lab 1 Census Data Quality for Policy Decisions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab2/Levy-Matthew-Assignment2.html">
 <span class="dropdown-text">Lab 2: Spatial Analysis and Visualization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab5/lab5.html">
 <span class="dropdown-text">Lab 5: Bike Share Prediction</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#the-rebalancing-challenge-in-philadelphia" id="toc-the-rebalancing-challenge-in-philadelphia" class="nav-link" data-scroll-target="#the-rebalancing-challenge-in-philadelphia">The Rebalancing Challenge in Philadelphia</a></li>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  <li><a href="#assignment-structure" id="toc-assignment-structure" class="nav-link" data-scroll-target="#assignment-structure">Assignment Structure</a></li>
  </ul></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#load-libraries" id="toc-load-libraries" class="nav-link" data-scroll-target="#load-libraries">Load Libraries</a></li>
  <li><a href="#define-themes" id="toc-define-themes" class="nav-link" data-scroll-target="#define-themes">Define Themes</a></li>
  <li><a href="#set-census-api-key" id="toc-set-census-api-key" class="nav-link" data-scroll-target="#set-census-api-key">Set Census API Key</a></li>
  </ul></li>
  <li><a href="#data-import-preparation" id="toc-data-import-preparation" class="nav-link" data-scroll-target="#data-import-preparation">Data Import &amp; Preparation</a>
  <ul class="collapse">
  <li><a href="#load-indego-trip-data-q1-2025" id="toc-load-indego-trip-data-q1-2025" class="nav-link" data-scroll-target="#load-indego-trip-data-q1-2025">Load Indego Trip Data (Q1 2025)</a></li>
  <li><a href="#examine-the-data-structure" id="toc-examine-the-data-structure" class="nav-link" data-scroll-target="#examine-the-data-structure">Examine the Data Structure</a></li>
  <li><a href="#create-time-bins" id="toc-create-time-bins" class="nav-link" data-scroll-target="#create-time-bins">Create Time Bins</a></li>
  </ul></li>
  <li><a href="#exploratory-analysis" id="toc-exploratory-analysis" class="nav-link" data-scroll-target="#exploratory-analysis">Exploratory Analysis</a>
  <ul class="collapse">
  <li><a href="#trips-over-time" id="toc-trips-over-time" class="nav-link" data-scroll-target="#trips-over-time">Trips Over Time</a></li>
  <li><a href="#hourly-patterns" id="toc-hourly-patterns" class="nav-link" data-scroll-target="#hourly-patterns">Hourly Patterns</a></li>
  </ul></li>
  <li><a href="#get-philadelphia-spatial-context" id="toc-get-philadelphia-spatial-context" class="nav-link" data-scroll-target="#get-philadelphia-spatial-context">Get Philadelphia Spatial Context</a>
  <ul class="collapse">
  <li><a href="#load-philadelphia-census-data" id="toc-load-philadelphia-census-data" class="nav-link" data-scroll-target="#load-philadelphia-census-data">Load Philadelphia Census Data</a></li>
  <li><a href="#map-philadelphia-context" id="toc-map-philadelphia-context" class="nav-link" data-scroll-target="#map-philadelphia-context">Map Philadelphia Context</a></li>
  <li><a href="#join-census-data-to-stations" id="toc-join-census-data-to-stations" class="nav-link" data-scroll-target="#join-census-data-to-stations">Join Census Data to Stations</a></li>
  </ul></li>
  <li><a href="#dealing-with-missing-data" id="toc-dealing-with-missing-data" class="nav-link" data-scroll-target="#dealing-with-missing-data">Dealing with missing data</a></li>
  <li><a href="#get-weather-data" id="toc-get-weather-data" class="nav-link" data-scroll-target="#get-weather-data">Get Weather Data</a>
  <ul class="collapse">
  <li><a href="#visualize-weather-patterns" id="toc-visualize-weather-patterns" class="nav-link" data-scroll-target="#visualize-weather-patterns">Visualize Weather Patterns</a></li>
  </ul></li>
  <li><a href="#create-space-time-panel" id="toc-create-space-time-panel" class="nav-link" data-scroll-target="#create-space-time-panel">Create Space-Time Panel</a>
  <ul class="collapse">
  <li><a href="#aggregate-trips-to-station-hour-level" id="toc-aggregate-trips-to-station-hour-level" class="nav-link" data-scroll-target="#aggregate-trips-to-station-hour-level">Aggregate Trips to Station-Hour Level</a></li>
  <li><a href="#create-complete-panel-structure" id="toc-create-complete-panel-structure" class="nav-link" data-scroll-target="#create-complete-panel-structure">Create Complete Panel Structure</a></li>
  <li><a href="#add-time-features" id="toc-add-time-features" class="nav-link" data-scroll-target="#add-time-features">Add Time Features</a></li>
  <li><a href="#join-weather-data" id="toc-join-weather-data" class="nav-link" data-scroll-target="#join-weather-data">Join Weather Data</a></li>
  </ul></li>
  <li><a href="#create-temporal-lag-variables" id="toc-create-temporal-lag-variables" class="nav-link" data-scroll-target="#create-temporal-lag-variables">Create Temporal Lag Variables</a>
  <ul class="collapse">
  <li><a href="#why-lags" id="toc-why-lags" class="nav-link" data-scroll-target="#why-lags">Why Lags?</a></li>
  <li><a href="#visualize-lag-correlations" id="toc-visualize-lag-correlations" class="nav-link" data-scroll-target="#visualize-lag-correlations">Visualize Lag Correlations</a></li>
  </ul></li>
  <li><a href="#temporal-traintest-split" id="toc-temporal-traintest-split" class="nav-link" data-scroll-target="#temporal-traintest-split">Temporal Train/Test Split</a>
  <ul class="collapse">
  <li><a href="#why-temporal-validation-matters" id="toc-why-temporal-validation-matters" class="nav-link" data-scroll-target="#why-temporal-validation-matters">Why Temporal Validation Matters</a></li>
  </ul></li>
  <li><a href="#build-predictive-models" id="toc-build-predictive-models" class="nav-link" data-scroll-target="#build-predictive-models">Build Predictive Models</a>
  <ul class="collapse">
  <li><a href="#model-1-baseline-time-weather" id="toc-model-1-baseline-time-weather" class="nav-link" data-scroll-target="#model-1-baseline-time-weather">Model 1: Baseline (Time + Weather)</a></li>
  <li><a href="#model-2-add-temporal-lags" id="toc-model-2-add-temporal-lags" class="nav-link" data-scroll-target="#model-2-add-temporal-lags">Model 2: Add Temporal Lags</a></li>
  <li><a href="#model-3-add-demographics" id="toc-model-3-add-demographics" class="nav-link" data-scroll-target="#model-3-add-demographics">Model 3: Add Demographics</a></li>
  <li><a href="#model-4-add-station-fixed-effects" id="toc-model-4-add-station-fixed-effects" class="nav-link" data-scroll-target="#model-4-add-station-fixed-effects">Model 4: Add Station Fixed Effects</a></li>
  <li><a href="#model-5-add-rush-hour-interaction" id="toc-model-5-add-rush-hour-interaction" class="nav-link" data-scroll-target="#model-5-add-rush-hour-interaction">Model 5: Add Rush Hour Interaction</a></li>
  </ul></li>
  <li><a href="#model-evaluation" id="toc-model-evaluation" class="nav-link" data-scroll-target="#model-evaluation">Model Evaluation</a>
  <ul class="collapse">
  <li><a href="#calculate-predictions-and-mae" id="toc-calculate-predictions-and-mae" class="nav-link" data-scroll-target="#calculate-predictions-and-mae">Calculate Predictions and MAE</a></li>
  <li><a href="#visualize-model-comparison" id="toc-visualize-model-comparison" class="nav-link" data-scroll-target="#visualize-model-comparison">Visualize Model Comparison</a></li>
  </ul></li>
  <li><a href="#space-time-error-analysis" id="toc-space-time-error-analysis" class="nav-link" data-scroll-target="#space-time-error-analysis">Space-Time Error Analysis</a>
  <ul class="collapse">
  <li><a href="#observed-vs.-predicted" id="toc-observed-vs.-predicted" class="nav-link" data-scroll-target="#observed-vs.-predicted">Observed vs.&nbsp;Predicted</a></li>
  <li><a href="#spatial-error-patterns" id="toc-spatial-error-patterns" class="nav-link" data-scroll-target="#spatial-error-patterns">Spatial Error Patterns</a></li>
  <li><a href="#temporal-error-patterns" id="toc-temporal-error-patterns" class="nav-link" data-scroll-target="#temporal-error-patterns">Temporal Error Patterns</a></li>
  <li><a href="#errors-and-demographics" id="toc-errors-and-demographics" class="nav-link" data-scroll-target="#errors-and-demographics">Errors and Demographics</a></li>
  <li><a href="#prediciton-error-has-a-postive-trend-with-an-increase-in-both-median-income-and-percentage-of-white-residents.-error-also-negative-relationship-with-transit-ridership.-whiter-wealthier-areas-of-the-city-tend-to-be-denser-and-near-center-city-or-other-economic-hub-which-are-where-indego-stations-are-more-densely-located.-it-could-be-thought-that-wealthier-and-whiter-areas-of-the-city-have-greater-options-when-deciding-which-indego-bike-station-to-use-whereas-more-diverse-and-poorer-areas-of-the-city-have-limited-options-if-any-at-all." id="toc-prediciton-error-has-a-postive-trend-with-an-increase-in-both-median-income-and-percentage-of-white-residents.-error-also-negative-relationship-with-transit-ridership.-whiter-wealthier-areas-of-the-city-tend-to-be-denser-and-near-center-city-or-other-economic-hub-which-are-where-indego-stations-are-more-densely-located.-it-could-be-thought-that-wealthier-and-whiter-areas-of-the-city-have-greater-options-when-deciding-which-indego-bike-station-to-use-whereas-more-diverse-and-poorer-areas-of-the-city-have-limited-options-if-any-at-all." class="nav-link" data-scroll-target="#prediciton-error-has-a-postive-trend-with-an-increase-in-both-median-income-and-percentage-of-white-residents.-error-also-negative-relationship-with-transit-ridership.-whiter-wealthier-areas-of-the-city-tend-to-be-denser-and-near-center-city-or-other-economic-hub-which-are-where-indego-stations-are-more-densely-located.-it-could-be-thought-that-wealthier-and-whiter-areas-of-the-city-have-greater-options-when-deciding-which-indego-bike-station-to-use-whereas-more-diverse-and-poorer-areas-of-the-city-have-limited-options-if-any-at-all.">Prediciton error has a postive trend with an increase in both median income and percentage of white residents. Error also negative relationship with transit ridership. Whiter, wealthier areas of the city tend to be denser and near center city or other economic hub, which are where Indego stations are more densely located. It could be thought that wealthier and whiter areas of the city have greater options when deciding which Indego bike station to use, whereas more diverse and poorer areas of the city have limited options if any at all.</a></li>
  </ul></li>
  <li><a href="#hw5-your-turn" id="toc-hw5-your-turn" class="nav-link" data-scroll-target="#hw5-your-turn">HW5: Your Turn!</a>
  <ul class="collapse">
  <li><a href="#part-1-replicate-with-different-quarter-alternately-you-could-do-a-longer-time-span-by-merging-multiple-quarters-together.-im-not-picky-about-that" id="toc-part-1-replicate-with-different-quarter-alternately-you-could-do-a-longer-time-span-by-merging-multiple-quarters-together.-im-not-picky-about-that" class="nav-link" data-scroll-target="#part-1-replicate-with-different-quarter-alternately-you-could-do-a-longer-time-span-by-merging-multiple-quarters-together.-im-not-picky-about-that">Part 1: Replicate with Different Quarter (alternately, you could do a longer time-span by merging multiple quarters together. I’m not picky about that)</a></li>
  </ul></li>
  <li><a href="#data-import-preparation-1" id="toc-data-import-preparation-1" class="nav-link" data-scroll-target="#data-import-preparation-1">Data Import &amp; Preparation</a>
  <ul class="collapse">
  <li><a href="#load-indego-trip-data-q2-2025" id="toc-load-indego-trip-data-q2-2025" class="nav-link" data-scroll-target="#load-indego-trip-data-q2-2025">Load Indego Trip Data (Q2 2025)</a></li>
  <li><a href="#examine-the-data-structure-1" id="toc-examine-the-data-structure-1" class="nav-link" data-scroll-target="#examine-the-data-structure-1">Examine the Data Structure</a></li>
  <li><a href="#create-time-bins-1" id="toc-create-time-bins-1" class="nav-link" data-scroll-target="#create-time-bins-1">Create Time Bins</a></li>
  </ul></li>
  <li><a href="#exploratory-analysis-1" id="toc-exploratory-analysis-1" class="nav-link" data-scroll-target="#exploratory-analysis-1">Exploratory Analysis</a>
  <ul class="collapse">
  <li><a href="#trips-over-time-1" id="toc-trips-over-time-1" class="nav-link" data-scroll-target="#trips-over-time-1">Trips Over Time</a></li>
  <li><a href="#hourly-patterns-1" id="toc-hourly-patterns-1" class="nav-link" data-scroll-target="#hourly-patterns-1">Hourly Patterns</a></li>
  <li><a href="#top-stations" id="toc-top-stations" class="nav-link" data-scroll-target="#top-stations">Top Stations</a></li>
  </ul></li>
  <li><a href="#get-philadelphia-spatial-context-1" id="toc-get-philadelphia-spatial-context-1" class="nav-link" data-scroll-target="#get-philadelphia-spatial-context-1">Get Philadelphia Spatial Context</a>
  <ul class="collapse">
  <li><a href="#load-philadelphia-census-data-1" id="toc-load-philadelphia-census-data-1" class="nav-link" data-scroll-target="#load-philadelphia-census-data-1">Load Philadelphia Census Data</a></li>
  <li><a href="#map-philadelphia-context-1" id="toc-map-philadelphia-context-1" class="nav-link" data-scroll-target="#map-philadelphia-context-1">Map Philadelphia Context</a></li>
  <li><a href="#join-census-data-to-stations-1" id="toc-join-census-data-to-stations-1" class="nav-link" data-scroll-target="#join-census-data-to-stations-1">Join Census Data to Stations</a></li>
  </ul></li>
  <li><a href="#dealing-with-missing-data-1" id="toc-dealing-with-missing-data-1" class="nav-link" data-scroll-target="#dealing-with-missing-data-1">Dealing with missing data</a></li>
  <li><a href="#get-weather-data-1" id="toc-get-weather-data-1" class="nav-link" data-scroll-target="#get-weather-data-1">Get Weather Data</a>
  <ul class="collapse">
  <li><a href="#visualize-weather-patterns-1" id="toc-visualize-weather-patterns-1" class="nav-link" data-scroll-target="#visualize-weather-patterns-1">Visualize Weather Patterns</a></li>
  </ul></li>
  <li><a href="#create-space-time-panel-1" id="toc-create-space-time-panel-1" class="nav-link" data-scroll-target="#create-space-time-panel-1">Create Space-Time Panel</a>
  <ul class="collapse">
  <li><a href="#aggregate-trips-to-station-hour-level-1" id="toc-aggregate-trips-to-station-hour-level-1" class="nav-link" data-scroll-target="#aggregate-trips-to-station-hour-level-1">Aggregate Trips to Station-Hour Level</a></li>
  <li><a href="#create-complete-panel-structure-1" id="toc-create-complete-panel-structure-1" class="nav-link" data-scroll-target="#create-complete-panel-structure-1">Create Complete Panel Structure</a></li>
  <li><a href="#add-time-features-1" id="toc-add-time-features-1" class="nav-link" data-scroll-target="#add-time-features-1">Add Time Features</a></li>
  <li><a href="#join-weather-data-1" id="toc-join-weather-data-1" class="nav-link" data-scroll-target="#join-weather-data-1">Join Weather Data</a></li>
  </ul></li>
  <li><a href="#create-temporal-lag-variables-1" id="toc-create-temporal-lag-variables-1" class="nav-link" data-scroll-target="#create-temporal-lag-variables-1">Create Temporal Lag Variables</a>
  <ul class="collapse">
  <li><a href="#visualize-lag-correlations-1" id="toc-visualize-lag-correlations-1" class="nav-link" data-scroll-target="#visualize-lag-correlations-1">Visualize Lag Correlations</a></li>
  </ul></li>
  <li><a href="#temporal-traintest-split-1" id="toc-temporal-traintest-split-1" class="nav-link" data-scroll-target="#temporal-traintest-split-1">Temporal Train/Test Split</a></li>
  <li><a href="#build-predictive-models-1" id="toc-build-predictive-models-1" class="nav-link" data-scroll-target="#build-predictive-models-1">Build Predictive Models</a>
  <ul class="collapse">
  <li><a href="#model-1-baseline-time-weather-1" id="toc-model-1-baseline-time-weather-1" class="nav-link" data-scroll-target="#model-1-baseline-time-weather-1">Model 1: Baseline (Time + Weather)</a></li>
  <li><a href="#model-2-add-temporal-lags-1" id="toc-model-2-add-temporal-lags-1" class="nav-link" data-scroll-target="#model-2-add-temporal-lags-1">Model 2: Add Temporal Lags</a></li>
  <li><a href="#model-3-add-demographics-1" id="toc-model-3-add-demographics-1" class="nav-link" data-scroll-target="#model-3-add-demographics-1">Model 3: Add Demographics</a></li>
  <li><a href="#model-4-add-station-fixed-effects-1" id="toc-model-4-add-station-fixed-effects-1" class="nav-link" data-scroll-target="#model-4-add-station-fixed-effects-1">Model 4: Add Station Fixed Effects</a></li>
  <li><a href="#model-5-add-rush-hour-interaction-1" id="toc-model-5-add-rush-hour-interaction-1" class="nav-link" data-scroll-target="#model-5-add-rush-hour-interaction-1">Model 5: Add Rush Hour Interaction</a></li>
  </ul></li>
  <li><a href="#model-evaluation-1" id="toc-model-evaluation-1" class="nav-link" data-scroll-target="#model-evaluation-1">Model Evaluation</a>
  <ul class="collapse">
  <li><a href="#calculate-predictions-and-mae-1" id="toc-calculate-predictions-and-mae-1" class="nav-link" data-scroll-target="#calculate-predictions-and-mae-1">Calculate Predictions and MAE</a></li>
  <li><a href="#visualize-model-comparison-1" id="toc-visualize-model-comparison-1" class="nav-link" data-scroll-target="#visualize-model-comparison-1">Visualize Model Comparison</a></li>
  <li><a href="#part-2-error-analysis" id="toc-part-2-error-analysis" class="nav-link" data-scroll-target="#part-2-error-analysis">Part 2: Error Analysis</a></li>
  </ul></li>
  <li><a href="#space-time-error-analysis-1" id="toc-space-time-error-analysis-1" class="nav-link" data-scroll-target="#space-time-error-analysis-1">Space-Time Error Analysis</a>
  <ul class="collapse">
  <li><a href="#observed-vs.-predicted-1" id="toc-observed-vs.-predicted-1" class="nav-link" data-scroll-target="#observed-vs.-predicted-1">Observed vs.&nbsp;Predicted</a></li>
  <li><a href="#spatial-error-patterns-1" id="toc-spatial-error-patterns-1" class="nav-link" data-scroll-target="#spatial-error-patterns-1">Spatial Error Patterns</a></li>
  <li><a href="#temporal-error-patterns-1" id="toc-temporal-error-patterns-1" class="nav-link" data-scroll-target="#temporal-error-patterns-1">Temporal Error Patterns</a></li>
  <li><a href="#errors-and-demographics-1" id="toc-errors-and-demographics-1" class="nav-link" data-scroll-target="#errors-and-demographics-1">Errors and Demographics</a></li>
  <li><a href="#part-4-critical-reflection" id="toc-part-4-critical-reflection" class="nav-link" data-scroll-target="#part-4-critical-reflection">Part 4: Critical Reflection</a></li>
  </ul></li>
  <li><a href="#submission-requirements" id="toc-submission-requirements" class="nav-link" data-scroll-target="#submission-requirements">Submission Requirements</a>
  <ul class="collapse">
  <li><a href="#what-to-submit-per-team" id="toc-what-to-submit-per-team" class="nav-link" data-scroll-target="#what-to-submit-per-team">What to Submit (per team)</a></li>
  <li><a href="#tips-for-success" id="toc-tips-for-success" class="nav-link" data-scroll-target="#tips-for-success">Tips for Success</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Space-Time Prediction of Bike Share Demand: Philadelphia Indego</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Matthew </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 1, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="the-rebalancing-challenge-in-philadelphia" class="level2">
<h2 class="anchored" data-anchor-id="the-rebalancing-challenge-in-philadelphia">The Rebalancing Challenge in Philadelphia</h2>
<p>Philadelphia’s Indego bike share system faces the same operational challenge as every bike share system: <strong>rebalancing bikes to meet anticipated demand</strong>.</p>
<p>Imagine you’re an Indego operations manager at 6:00 AM on a Monday morning. You have: - 200 stations across Philadelphia - Limited trucks and staff for moving bikes - 2-3 hours before morning rush hour demand peaks - <strong>The question:</strong> Which stations will run out of bikes by 8:30 AM?</p>
<p>This lab will teach you to build predictive models that forecast bike share demand across <strong>space</strong> (different stations) and <strong>time</strong> (different hours) to help solve this operational problem.</p>
</section>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By the end of this assignment, you will be able to:</p>
<ol type="1">
<li><strong>Understand panel data structure</strong> for space-time analysis</li>
<li><strong>Create temporal lag variables</strong> to capture demand persistence</li>
<li><strong>Build multiple predictive models</strong> with increasing complexity</li>
<li><strong>Validate models temporally</strong> (train on past, test on future)</li>
<li><strong>Analyze prediction errors</strong> in both space and time</li>
<li><strong>Engineer new features</strong> based on error patterns</li>
<li><strong>Critically evaluate</strong> when prediction errors matter most</li>
</ol>
</section>
<section id="assignment-structure" class="level2">
<h2 class="anchored" data-anchor-id="assignment-structure">Assignment Structure</h2>
<p><strong>Part 1 (In-Class/Together):</strong> Work through Q1 2025 data following this code</p>
<p><strong>Part 2 (HW5 - Teams of 2):</strong> - Download a different quarter of Indego data (Q2, Q3, or Q4 2024) - Apply the same workflow to your quarter - Analyze error patterns in your quarter - Add 2-3 new features to improve the model - Write a brief report on what you learned</p>
<hr>
</section>
</section>
<section id="setup" class="level1">
<h1>Setup</h1>
<section id="load-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-libraries">Load Libraries</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Core tidyverse</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial data</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("tigris")</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Census data</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Weather data</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(riem)  <span class="co"># For Philadelphia weather from ASOS stations</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># here!</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">#for setting data path </span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"this.path"</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Get rid of scientific notation. We gotta look good!</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="define-themes" class="level2">
<h2 class="anchored" data-anchor-id="define-themes">Define Themes</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>plotTheme <span class="ot">&lt;-</span> <span class="fu">theme</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"#D0D0D0"</span>, <span class="at">size =</span> <span class="fl">0.2</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>mapTheme <span class="ot">&lt;-</span> <span class="fu">theme</span>(</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.line =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">'transparent'</span>),</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="st">'cm'</span>),</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>),</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>palette5 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#eff3ff"</span>, <span class="st">"#bdd7e7"</span>, <span class="st">"#6baed6"</span>, <span class="st">"#3182bd"</span>, <span class="st">"#08519c"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="set-census-api-key" class="level2">
<h2 class="anchored" data-anchor-id="set-census-api-key">Set Census API Key</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">census_api_key</span>(<span class="st">"YOUR_Key_Here"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>, <span class="at">install =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
</section>
<section id="data-import-preparation" class="level1">
<h1>Data Import &amp; Preparation</h1>
<section id="load-indego-trip-data-q1-2025" class="level2">
<h2 class="anchored" data-anchor-id="load-indego-trip-data-q1-2025">Load Indego Trip Data (Q1 2025)</h2>
<p><strong>Note for HW5:</strong> You’ll download a different quarter from: https://www.rideindego.com/about/data/</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#get current directory (not same as project home)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>curDir <span class="ot">&lt;-</span> <span class="fu">dirname</span>(<span class="fu">this.path</span>())</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(curDir)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read Q1 2025 data</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>indego <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"data/indego-trips-2025-q1.csv"</span>))</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick look at the data</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(indego)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 201,588
Columns: 15
$ trip_id             &lt;dbl&gt; 1123985990, 1123986350, 1124202498, 1123986241, 11…
$ duration            &lt;dbl&gt; 5, 14, 894, 9, 13, 11, 15, 19, 20, 24, 26, 11, 12,…
$ start_time          &lt;chr&gt; "1/1/2025 0:00", "1/1/2025 0:04", "1/1/2025 0:05",…
$ end_time            &lt;chr&gt; "1/1/2025 0:05", "1/1/2025 0:18", "1/1/2025 14:59"…
$ start_station       &lt;dbl&gt; 3371, 3344, 3021, 3253, 3182, 3346, 3049, 3112, 31…
$ start_lat           &lt;dbl&gt; 39.95340, 39.95961, 39.95390, 39.93074, 39.95081, …
$ start_lon           &lt;dbl&gt; -75.15430, -75.23354, -75.16902, -75.18924, -75.16…
$ end_station         &lt;dbl&gt; 3378, 3294, 3073, 3253, 3249, 3000, 3100, 3035, 33…
$ end_lat             &lt;dbl&gt; 39.95238, 39.95174, 39.96143, 39.93074, 39.95784, …
$ end_lon             &lt;dbl&gt; -75.14728, -75.17063, -75.15242, -75.18924, -75.19…
$ bike_id             &lt;chr&gt; "22580", "31417", "31393", "31434", "22872", "1187…
$ plan_duration       &lt;dbl&gt; 30, 365, 1, 30, 1, 365, 30, 30, 365, 365, 30, 365,…
$ trip_route_category &lt;chr&gt; "One Way", "One Way", "One Way", "Round Trip", "On…
$ passholder_type     &lt;chr&gt; "Indego30", "Indego365", "Walk-up", "Indego30", "W…
$ bike_type           &lt;chr&gt; "electric", "electric", "electric", "electric", "e…</code></pre>
</div>
</div>
</section>
<section id="examine-the-data-structure" class="level2">
<h2 class="anchored" data-anchor-id="examine-the-data-structure">Examine the Data Structure</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many trips?</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total trips in Q1 2025:"</span>, <span class="fu">nrow</span>(indego), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total trips in Q1 2025: 201588 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Date range</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Date range:"</span>, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">min</span>(<span class="fu">mdy_hm</span>(indego<span class="sc">$</span>start_time)), <span class="st">"to"</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">max</span>(<span class="fu">mdy_hm</span>(indego<span class="sc">$</span>start_time)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Date range: 1735689600 to 1743464880 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many unique stations?</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Unique start stations:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(indego<span class="sc">$</span>start_station)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Unique start stations: 265 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Trip types</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(indego<span class="sc">$</span>trip_route_category)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   One Way Round Trip 
    190792      10796 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Passholder types</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(indego<span class="sc">$</span>passholder_type)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  Day Pass   Indego30  Indego365 IndegoFlex    Walk-up 
      5494      94044      91628          3      10419 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bike types</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(indego<span class="sc">$</span>bike_type)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
electric standard 
  129561    72027 </code></pre>
</div>
</div>
</section>
<section id="create-time-bins" class="level2">
<h2 class="anchored" data-anchor-id="create-time-bins">Create Time Bins</h2>
<p>We need to aggregate trips into hourly intervals for our panel data structure.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>indego <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse datetime</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_datetime =</span> <span class="fu">mdy_hm</span>(start_time),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_datetime =</span> <span class="fu">mdy_hm</span>(end_time),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create hourly bins</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">interval60 =</span> <span class="fu">floor_date</span>(start_datetime, <span class="at">unit =</span> <span class="st">"hour"</span>),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract time features</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">week =</span> <span class="fu">week</span>(interval60),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">dotw =</span> <span class="fu">wday</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">hour =</span> <span class="fu">hour</span>(interval60),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(interval60),</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create useful indicators</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekend =</span> <span class="fu">ifelse</span>(dotw <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">rush_hour =</span> <span class="fu">ifelse</span>(hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at temporal features</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(indego <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_datetime, interval60, week, dotw, hour, weekend))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  start_datetime      interval60           week dotw   hour weekend
  &lt;dttm&gt;              &lt;dttm&gt;              &lt;dbl&gt; &lt;ord&gt; &lt;int&gt;   &lt;dbl&gt;
1 2025-01-01 00:00:00 2025-01-01 00:00:00     1 Wed       0       0
2 2025-01-01 00:04:00 2025-01-01 00:00:00     1 Wed       0       0
3 2025-01-01 00:05:00 2025-01-01 00:00:00     1 Wed       0       0
4 2025-01-01 00:05:00 2025-01-01 00:00:00     1 Wed       0       0
5 2025-01-01 00:08:00 2025-01-01 00:00:00     1 Wed       0       0
6 2025-01-01 00:14:00 2025-01-01 00:00:00     1 Wed       0       0</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="exploratory-analysis" class="level1">
<h1>Exploratory Analysis</h1>
<section id="trips-over-time" class="level2">
<h2 class="anchored" data-anchor-id="trips-over-time">Trips Over Time</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily trip counts</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>daily_trips <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">trips =</span> <span class="fu">n</span>())</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(daily_trips, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> trips)) <span class="sc">+</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#3182bd"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Indego Daily Ridership - Q1 2025"</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Winter demand patterns in Philadelphia"</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Daily Trips"</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Indego bike share"</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/trips_over_time-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Question:</strong> What patterns do you see? How does ridership change over time?</p>
<p>There is a genreal increase of ridership over time, which is most likely due to improvements in weather conditions making biking both be and feel more accessible and safe to more people. Furthermore, there is a major peak in mid-Febuary. This coincides with the Eagles’ superbowl victory and corresponding parade.</p>
<p>Notice a big spike in Februrary of 2025 (the 14th - not just Valentine’s Day)? Was anybody in Philly last Feb? What closed everything and cancelled my PPA class? … Hint: Fly Eagles Fly</p>
<p>Let’s investigate…compare the 14th to all other Friday’s in the data…what did you find? Keep this in mind for future Feature Engineering.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fly_eagles_fly <span class="ot">&lt;-</span> daily_trips <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> <span class="st">"2025-02-14"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>typical_boring_friday <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dotw <span class="sc">==</span> <span class="st">"Fri"</span>, date <span class="sc">!=</span> <span class="st">"2025-02-14"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">trips =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">avg_friday_trips =</span> <span class="fu">mean</span>(trips))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fly_eagles_fly)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  date       trips
  &lt;date&gt;     &lt;int&gt;
1 2025-02-14  4192</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(typical_boring_friday)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  avg_friday_trips
             &lt;dbl&gt;
1            2319.</code></pre>
</div>
</div>
</section>
<section id="hourly-patterns" class="level2">
<h2 class="anchored" data-anchor-id="hourly-patterns">Hourly Patterns</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Average trips by hour and day type</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>hourly_patterns <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hour, weekend) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">avg_trips =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="fu">n_distinct</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day_type =</span> <span class="fu">ifelse</span>(weekend <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>))</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hourly_patterns, <span class="fu">aes</span>(<span class="at">x =</span> hour, <span class="at">y =</span> avg_trips, <span class="at">color =</span> day_type)) <span class="sc">+</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> <span class="st">"#08519c"</span>, <span class="st">"Weekend"</span> <span class="ot">=</span> <span class="st">"#6baed6"</span>)) <span class="sc">+</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Average Hourly Ridership Patterns"</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Clear commute patterns on weekdays"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Hour of Day"</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Trips per Hour"</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Day Type"</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/hourly_patterns-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Question:</strong> When are the peak hours? How do weekends differ from weekdays? During the week, ridership peaks around 8:00am and 5:00pm. These peaks correspond with the start and end of the work day, illustrating Indego’s commuting functionality. On the week, however, the stark peaks are exchanged for a more gentle curve. Peak ridership occurs around noon and the early afternoon, demonstrating a more recreational or casual usage of Indego. ## Top Stations</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Most popular origin stations</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>top_stations <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(start_station, start_lat, start_lon, <span class="at">name =</span> <span class="st">"trips"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(trips)) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">20</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(top_stations, </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Top 20 Indego Stations by Trip Origins"</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small">
<caption>Top 20 Indego Stations by Trip Origins</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">start_station</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">start_lat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">start_lon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">trips</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">3,010</td>
<td style="text-align: right;">39.94711</td>
<td style="text-align: right;">-75.16618</td>
<td style="text-align: right;">3,999</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,032</td>
<td style="text-align: right;">39.94527</td>
<td style="text-align: right;">-75.17971</td>
<td style="text-align: right;">2,842</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,359</td>
<td style="text-align: right;">39.94888</td>
<td style="text-align: right;">-75.16978</td>
<td style="text-align: right;">2,699</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,020</td>
<td style="text-align: right;">39.94855</td>
<td style="text-align: right;">-75.19007</td>
<td style="text-align: right;">2,673</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,208</td>
<td style="text-align: right;">39.95048</td>
<td style="text-align: right;">-75.19324</td>
<td style="text-align: right;">2,503</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,244</td>
<td style="text-align: right;">39.93865</td>
<td style="text-align: right;">-75.16674</td>
<td style="text-align: right;">2,486</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,066</td>
<td style="text-align: right;">39.94561</td>
<td style="text-align: right;">-75.17348</td>
<td style="text-align: right;">2,396</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,362</td>
<td style="text-align: right;">39.94816</td>
<td style="text-align: right;">-75.16226</td>
<td style="text-align: right;">2,387</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,012</td>
<td style="text-align: right;">39.94218</td>
<td style="text-align: right;">-75.17747</td>
<td style="text-align: right;">2,361</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,028</td>
<td style="text-align: right;">39.94061</td>
<td style="text-align: right;">-75.14958</td>
<td style="text-align: right;">2,348</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,161</td>
<td style="text-align: right;">39.95486</td>
<td style="text-align: right;">-75.18091</td>
<td style="text-align: right;">2,278</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,101</td>
<td style="text-align: right;">39.94295</td>
<td style="text-align: right;">-75.15955</td>
<td style="text-align: right;">2,274</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,295</td>
<td style="text-align: right;">39.95028</td>
<td style="text-align: right;">-75.16027</td>
<td style="text-align: right;">2,160</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,054</td>
<td style="text-align: right;">39.96250</td>
<td style="text-align: right;">-75.17420</td>
<td style="text-align: right;">2,123</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,185</td>
<td style="text-align: right;">39.95169</td>
<td style="text-align: right;">-75.15888</td>
<td style="text-align: right;">2,116</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,038</td>
<td style="text-align: right;">39.94781</td>
<td style="text-align: right;">-75.19409</td>
<td style="text-align: right;">2,111</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,203</td>
<td style="text-align: right;">39.94077</td>
<td style="text-align: right;">-75.17227</td>
<td style="text-align: right;">2,106</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,059</td>
<td style="text-align: right;">39.96244</td>
<td style="text-align: right;">-75.16121</td>
<td style="text-align: right;">2,027</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,022</td>
<td style="text-align: right;">39.95472</td>
<td style="text-align: right;">-75.18323</td>
<td style="text-align: right;">2,014</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,063</td>
<td style="text-align: right;">39.94633</td>
<td style="text-align: right;">-75.16980</td>
<td style="text-align: right;">2,014</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
</section>
<section id="get-philadelphia-spatial-context" class="level1">
<h1>Get Philadelphia Spatial Context</h1>
<section id="load-philadelphia-census-data" class="level2">
<h2 class="anchored" data-anchor-id="load-philadelphia-census-data">Load Philadelphia Census Data</h2>
<p>We’ll get census tract data to add demographic context to our stations.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get Philadelphia census tracts</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>philly_census <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">geography =</span> <span class="st">"tract"</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="fu">c</span>(</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B01003_001"</span>,  <span class="co"># Total population</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B19013_001"</span>,  <span class="co"># Median household income</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B08301_001"</span>,  <span class="co"># Total commuters</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B08301_010"</span>,  <span class="co"># Commute by transit</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B02001_002"</span>,  <span class="co"># White alone</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B25077_001"</span>   <span class="co"># Median home value</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">state =</span> <span class="st">"PA"</span>,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">county =</span> <span class="st">"Philadelphia"</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="dv">2022</span>,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">geometry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="st">"wide"</span>,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">progress =</span> <span class="cn">FALSE</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Pop =</span> B01003_001E,</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">Med_Inc =</span> B19013_001E,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Commuters =</span> B08301_001E,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">Transit_Commuters =</span> B08301_010E,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">White_Pop =</span> B02001_002E,</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">Med_Home_Value =</span> B25077_001E</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_Taking_Transit =</span> (Transit_Commuters <span class="sc">/</span> Total_Commuters) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_White =</span> (White_Pop <span class="sc">/</span> Total_Pop) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>)  <span class="co"># WGS84 for lat/lon matching</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the data</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(philly_census)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 408
Columns: 17
$ GEOID                  &lt;chr&gt; "42101001500", "42101001800", "42101002802", "4…
$ NAME                   &lt;chr&gt; "Census Tract 15; Philadelphia County; Pennsylv…
$ Total_Pop              &lt;dbl&gt; 3251, 3300, 5720, 4029, 4415, 1815, 3374, 2729,…
$ B01003_001M            &lt;dbl&gt; 677, 369, 796, 437, 853, 210, 480, 734, 763, 11…
$ Med_Inc                &lt;dbl&gt; 110859, 114063, 78871, 61583, 32347, 48581, 597…
$ B19013_001M            &lt;dbl&gt; 24975, 30714, 20396, 22293, 4840, 13812, 6278, …
$ Total_Commuters        &lt;dbl&gt; 2073, 2255, 3032, 2326, 1980, 969, 2427, 708, 2…
$ B08301_001M            &lt;dbl&gt; 387, 308, 478, 383, 456, 189, 380, 281, 456, 68…
$ Transit_Commuters      &lt;dbl&gt; 429, 123, 685, 506, 534, 192, 658, 218, 438, 51…
$ B08301_010M            &lt;dbl&gt; 188, 66, 219, 144, 285, 71, 278, 184, 176, 235,…
$ White_Pop              &lt;dbl&gt; 2185, 2494, 3691, 3223, 182, 984, 2111, 231, 35…
$ B02001_002M            &lt;dbl&gt; 268, 381, 592, 380, 88, 190, 463, 112, 238, 778…
$ Med_Home_Value         &lt;dbl&gt; 568300, 605000, 350600, 296400, 76600, 289700, …
$ B25077_001M            &lt;dbl&gt; 58894, 34876, 12572, 22333, 10843, 118720, 1506…
$ geometry               &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((-75.16558 3..., MU…
$ Percent_Taking_Transit &lt;dbl&gt; 20.694645, 5.454545, 22.592348, 21.754084, 26.9…
$ Percent_White          &lt;dbl&gt; 67.2100892, 75.5757576, 64.5279720, 79.9950360,…</code></pre>
</div>
</div>
</section>
<section id="map-philadelphia-context" class="level2">
<h2 class="anchored" data-anchor-id="map-philadelphia-context">Map Philadelphia Context</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Map median income</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="fu">aes</span>(<span class="at">fill =</span> Med_Inc), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Median</span><span class="sc">\n</span><span class="st">Income"</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span>dollar</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Philadelphia Median Household Income by Census Tract"</span>,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Context for understanding bike share demand patterns"</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stations </span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> indego,</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon, <span class="at">y =</span> start_lat),</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.25</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  mapTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/map_philly-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="join-census-data-to-stations" class="level2">
<h2 class="anchored" data-anchor-id="join-census-data-to-stations">Join Census Data to Stations</h2>
<p>We’ll spatially join census characteristics to each bike station.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sf object for stations</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>stations_sf <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station, start_lat, start_lon) <span class="sc">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat), <span class="sc">!</span><span class="fu">is.na</span>(start_lon)) <span class="sc">%&gt;%</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"start_lon"</span>, <span class="st">"start_lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join to get census tract for each station</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>stations_census <span class="ot">&lt;-</span> <span class="fu">st_join</span>(stations_sf, philly_census, <span class="at">left =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the result - investigate whether all of the stations joined to census data -- according to the map above there are stations in non-residential tracts.</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>stations_for_map <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station, start_lat, start_lon) <span class="sc">%&gt;%</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat), <span class="sc">!</span><span class="fu">is.na</span>(start_lon)) <span class="sc">%&gt;%</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_station, Med_Inc),</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">has_census =</span> <span class="sc">!</span><span class="fu">is.na</span>(Med_Inc))</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add back to trip data</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>indego_census <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> </span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(start_station, Med_Inc, Percent_Taking_Transit, </span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>             Percent_White, Total_Pop),</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for visualization</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>stations_for_map <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station, start_lat, start_lon) <span class="sc">%&gt;%</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat), <span class="sc">!</span><span class="fu">is.na</span>(start_lon)) <span class="sc">%&gt;%</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_station, Med_Inc),</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">has_census =</span> <span class="sc">!</span><span class="fu">is.na</span>(Med_Inc))</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the map showing problem stations</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="fu">aes</span>(<span class="at">fill =</span> Med_Inc), <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Median</span><span class="sc">\n</span><span class="st">Income"</span>,</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span>dollar,</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">"grey90"</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stations with census data (small grey dots)</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stations_for_map <span class="sc">%&gt;%</span> <span class="fu">filter</span>(has_census),</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon, <span class="at">y =</span> start_lat),</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"grey30"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stations WITHOUT census data (red X marks the spot)</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stations_for_map <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>has_census),</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon, <span class="at">y =</span> start_lat),</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">shape =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Philadelphia Median Household Income by Census Tract"</span>,</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Indego stations shown (RED = no census data match)"</span>,</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Red X marks indicate stations that didn't join to census tracts"</span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>  mapTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/join_census_to_stations-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="dealing-with-missing-data" class="level1">
<h1>Dealing with missing data</h1>
<p>We need to decide what to do with the non-residential bike share stations. For this example, we are going to remove them – this is not necessarily the right way to do things always, but for the sake of simplicity, we are narrowing our scope to only stations in residential neighborhoods. We might opt to create a separate model for non-residential stations..</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify which stations to keep</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>valid_stations <span class="ot">&lt;-</span> stations_census <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Med_Inc)) <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(start_station)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter trip data to valid stations only</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>indego_census <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(start_station <span class="sc">%in%</span> valid_stations) <span class="sc">%&gt;%</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(start_station, Med_Inc, Percent_Taking_Transit, </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>             Percent_White, Total_Pop),</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="get-weather-data" class="level1">
<h1>Get Weather Data</h1>
<p>Weather significantly affects bike share demand! Let’s get hourly weather for Philadelphia.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get weather from Philadelphia International Airport (KPHL)</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This covers Q1 2025: January 1 - March 31</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>weather_data <span class="ot">&lt;-</span> <span class="fu">riem_measures</span>(</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">station =</span> <span class="st">"PHL"</span>,  <span class="co"># Philadelphia International Airport</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_start =</span> <span class="st">"2025-01-01"</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_end =</span> <span class="st">"2025-03-31"</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Process weather data</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>weather_processed <span class="ot">&lt;-</span> weather_data <span class="sc">%&gt;%</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">interval60 =</span> <span class="fu">floor_date</span>(valid, <span class="at">unit =</span> <span class="st">"hour"</span>),</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Temperature =</span> tmpf,  <span class="co"># Temperature in Fahrenheit</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Precipitation =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(p01i), <span class="dv">0</span>, p01i),  <span class="co"># Hourly precip in inches</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Wind_Speed =</span> sknt  <span class="co"># Wind speed in knots</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(interval60, Temperature, Precipitation, Wind_Speed) <span class="sc">%&gt;%</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing hours and interpolate if needed</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>weather_complete <span class="ot">&lt;-</span> weather_processed <span class="sc">%&gt;%</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">interval60 =</span> <span class="fu">seq</span>(<span class="fu">min</span>(interval60), <span class="fu">max</span>(interval60), <span class="at">by =</span> <span class="st">"hour"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(Temperature, Precipitation, Wind_Speed, <span class="at">.direction =</span> <span class="st">"down"</span>)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the weather</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(weather_complete <span class="sc">%&gt;%</span> <span class="fu">select</span>(Temperature, Precipitation, Wind_Speed))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Temperature    Precipitation        Wind_Speed    
 Min.   :10.00   Min.   :0.000000   Min.   : 0.000  
 1st Qu.:30.00   1st Qu.:0.000000   1st Qu.: 5.000  
 Median :37.00   Median :0.000000   Median : 8.000  
 Mean   :38.66   Mean   :0.005459   Mean   : 9.047  
 3rd Qu.:47.00   3rd Qu.:0.000000   3rd Qu.:12.000  
 Max.   :78.00   Max.   :0.710000   Max.   :30.000  </code></pre>
</div>
</div>
<section id="visualize-weather-patterns" class="level2">
<h2 class="anchored" data-anchor-id="visualize-weather-patterns">Visualize Weather Patterns</h2>
<p>Who is ready for a Philly winter?!</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weather_complete, <span class="fu">aes</span>(<span class="at">x =</span> interval60, <span class="at">y =</span> Temperature)) <span class="sc">+</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#3182bd"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Philadelphia Temperature - Q1 2025"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Winter to early spring transition"</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Temperature (°F)"</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/visualize_weather-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="create-space-time-panel" class="level1">
<h1>Create Space-Time Panel</h1>
<section id="aggregate-trips-to-station-hour-level" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-trips-to-station-hour-level">Aggregate Trips to Station-Hour Level</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count trips by station-hour</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>trips_panel <span class="ot">&lt;-</span> indego_census <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(interval60, start_station, start_lat, start_lon,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>           Med_Inc, Percent_Taking_Transit, Percent_White, Total_Pop) <span class="sc">%&gt;%</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Trip_Count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># How many station-hour observations?</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(trips_panel)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 116718</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many unique stations?</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>start_station))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 245</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many unique hours?</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>interval60))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2150</code></pre>
</div>
</div>
</section>
<section id="create-complete-panel-structure" class="level2">
<h2 class="anchored" data-anchor-id="create-complete-panel-structure">Create Complete Panel Structure</h2>
<p>Not every station has trips every hour. We need a <strong>complete panel</strong> where every station-hour combination exists (even if Trip_Count = 0).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate expected panel size</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>n_stations <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>start_station))</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>n_hours <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>interval60))</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>expected_rows <span class="ot">&lt;-</span> n_stations <span class="sc">*</span> n_hours</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Expected panel rows:"</span>, <span class="fu">format</span>(expected_rows, <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Expected panel rows: 526,750 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Current rows:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(trips_panel), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Current rows: 116,718 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Missing rows:"</span>, <span class="fu">format</span>(expected_rows <span class="sc">-</span> <span class="fu">nrow</span>(trips_panel), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Missing rows: 410,032 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create complete panel</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">interval60 =</span> <span class="fu">unique</span>(trips_panel<span class="sc">$</span>interval60),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_station =</span> <span class="fu">unique</span>(trips_panel<span class="sc">$</span>start_station)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join trip counts</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(trips_panel, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"interval60"</span>, <span class="st">"start_station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replace NA trip counts with 0</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Trip_Count =</span> <span class="fu">replace_na</span>(Trip_Count, <span class="dv">0</span>))</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill in station attributes (they're the same for all hours)</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>station_attributes <span class="ot">&lt;-</span> trips_panel <span class="sc">%&gt;%</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_lat =</span> <span class="fu">first</span>(start_lat),</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_lon =</span> <span class="fu">first</span>(start_lon),</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Med_Inc =</span> <span class="fu">first</span>(Med_Inc),</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_Taking_Transit =</span> <span class="fu">first</span>(Percent_Taking_Transit),</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_White =</span> <span class="fu">first</span>(Percent_White),</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Pop =</span> <span class="fu">first</span>(Total_Pop)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_attributes, <span class="at">by =</span> <span class="st">"start_station"</span>)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify we have complete panel</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Complete panel rows:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(study_panel), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Complete panel rows: 526,750 </code></pre>
</div>
</div>
</section>
<section id="add-time-features" class="level2">
<h2 class="anchored" data-anchor-id="add-time-features">Add Time Features</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">week =</span> <span class="fu">week</span>(interval60),</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">dotw =</span> <span class="fu">wday</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">hour =</span> <span class="fu">hour</span>(interval60),</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(interval60),</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekend =</span> <span class="fu">ifelse</span>(dotw <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">rush_hour =</span> <span class="fu">ifelse</span>(hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="join-weather-data" class="level2">
<h2 class="anchored" data-anchor-id="join-weather-data">Join Weather Data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(weather_complete, <span class="at">by =</span> <span class="st">"interval60"</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing values</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(study_panel <span class="sc">%&gt;%</span> <span class="fu">select</span>(Trip_Count, Temperature, Precipitation))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Trip_Count     Temperature   Precipitation   
 Min.   : 0.00   Min.   :10.0   Min.   :0.0000  
 1st Qu.: 0.00   1st Qu.:30.0   1st Qu.:0.0000  
 Median : 0.00   Median :37.0   Median :0.0000  
 Mean   : 0.34   Mean   :38.7   Mean   :0.0055  
 3rd Qu.: 0.00   3rd Qu.:47.0   3rd Qu.:0.0000  
 Max.   :26.00   Max.   :78.0   Max.   :0.7100  
                 NA's   :5880   NA's   :5880    </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="create-temporal-lag-variables" class="level1">
<h1>Create Temporal Lag Variables</h1>
<p>The key innovation for space-time prediction: <strong>past demand predicts future demand</strong>.</p>
<section id="why-lags" class="level2">
<h2 class="anchored" data-anchor-id="why-lags">Why Lags?</h2>
<p>If there were 15 bike trips from Station A at 8:00 AM, there will probably be ~15 trips at 9:00 AM. We can use this temporal persistence to improve predictions.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by station and time</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(start_station, interval60)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create lag variables WITHIN each station</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag1Hour =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">1</span>),</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag2Hours =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">2</span>),</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag3Hours =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">3</span>),</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag12Hours =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">12</span>),</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag1day =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">24</span>)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows with NA lags (first 24 hours for each station)</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>study_panel_complete <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lag1day))</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows after removing NA lags:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(study_panel_complete), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows after removing NA lags: 635,775 </code></pre>
</div>
</div>
</section>
<section id="visualize-lag-correlations" class="level2">
<h2 class="anchored" data-anchor-id="visualize-lag-correlations">Visualize Lag Correlations</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample one station to visualize</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>example_station <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(start_station <span class="sc">==</span> <span class="fu">first</span>(start_station)) <span class="sc">%&gt;%</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">168</span>)  <span class="co"># One week</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot actual vs lagged demand</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(example_station, <span class="fu">aes</span>(<span class="at">x =</span> interval60)) <span class="sc">+</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Trip_Count, <span class="at">color =</span> <span class="st">"Current"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> lag1Hour, <span class="at">color =</span> <span class="st">"1 Hour Ago"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> lag1day, <span class="at">color =</span> <span class="st">"24 Hours Ago"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Current"</span> <span class="ot">=</span> <span class="st">"#08519c"</span>,</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1 Hour Ago"</span> <span class="ot">=</span> <span class="st">"#3182bd"</span>,</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"24 Hours Ago"</span> <span class="ot">=</span> <span class="st">"#6baed6"</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Temporal Lag Patterns at One Station"</span>,</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Past demand predicts future demand"</span>,</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date-Time"</span>,</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Trip Count"</span>,</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Time Period"</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/lag_correlations-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="temporal-traintest-split" class="level1">
<h1>Temporal Train/Test Split</h1>
<p><strong>CRITICAL:</strong> We must train on PAST data and test on FUTURE data!</p>
<section id="why-temporal-validation-matters" class="level2">
<h2 class="anchored" data-anchor-id="why-temporal-validation-matters">Why Temporal Validation Matters</h2>
<p>In real operations, at 6:00 AM on March 15, we need to predict demand for March 15-31. We have data from Jan 1 - March 14, but NOT from March 15-31 (it hasn’t happened yet!).</p>
<p><strong>Wrong approach:</strong> Train on weeks 10-13, test on weeks 1-9 (predicting past from future!)</p>
<p><strong>Correct approach:</strong> Train on weeks 1-9, test on weeks 10-13 (predicting future from past)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split by week</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Q1 has weeks 1-13 (Jan-Mar)</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Train on weeks 1-9 (Jan 1 - early March)</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test on weeks 10-13 (rest of March)</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Which stations have trips in BOTH early and late periods?</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>early_stations <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&lt;</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trip_Count <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(start_station)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>late_stations <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trip_Count <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(start_station)</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only stations that appear in BOTH periods</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>common_stations <span class="ot">&lt;-</span> <span class="fu">intersect</span>(early_stations, late_stations)</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter panel to only common stations</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>study_panel_complete <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(start_station <span class="sc">%in%</span> common_stations)</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a><span class="co"># NOW create train/test split</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&lt;</span> <span class="dv">10</span>)</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&gt;=</span> <span class="dv">10</span>)</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Training observations:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(train), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Training observations: 428,400 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing observations:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(test), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Testing observations: 189,210 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Training date range:"</span>, <span class="fu">min</span>(train<span class="sc">$</span>date), <span class="st">"to"</span>, <span class="fu">max</span>(train<span class="sc">$</span>date), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Training date range: 20089 to 20151 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing date range:"</span>, <span class="fu">min</span>(test<span class="sc">$</span>date), <span class="st">"to"</span>, <span class="fu">max</span>(test<span class="sc">$</span>date), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Testing date range: 20152 to 20178 </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="build-predictive-models" class="level1">
<h1>Build Predictive Models</h1>
<p>We’ll build 5 models with increasing complexity to see what improves predictions.</p>
<section id="model-1-baseline-time-weather" class="level2">
<h2 class="anchored" data-anchor-id="model-1-baseline-time-weather">Model 1: Baseline (Time + Weather)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create day of week factor with treatment (dummy) coding</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> train <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dotw_simple =</span> <span class="fu">factor</span>(dotw, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>, <span class="st">"Sat"</span>, <span class="st">"Sun"</span>)))</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set contrasts to treatment coding (dummy variables)</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(train<span class="sc">$</span>dotw_simple) <span class="ot">&lt;-</span> <span class="fu">contr.treatment</span>(<span class="dv">7</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Now run the model</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation,</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation, data = train)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.8820 -0.3802 -0.1791  0.0128 18.5540 

Coefficients:
                    Estimate Std. Error t value             Pr(&gt;|t|)    
(Intercept)       -0.1488732  0.0077026 -19.328 &lt; 0.0000000000000002 ***
as.factor(hour)1  -0.0182693  0.0078250  -2.335               0.0196 *  
as.factor(hour)2  -0.0401185  0.0078013  -5.143   0.0000002711413737 ***
as.factor(hour)3  -0.0534144  0.0077758  -6.869   0.0000000000064582 ***
as.factor(hour)4  -0.0420757  0.0078905  -5.332   0.0000000969595824 ***
as.factor(hour)5   0.0145021  0.0078916   1.838               0.0661 .  
as.factor(hour)6   0.1551150  0.0078162  19.845 &lt; 0.0000000000000002 ***
as.factor(hour)7   0.2839418  0.0077451  36.661 &lt; 0.0000000000000002 ***
as.factor(hour)8   0.5012789  0.0077165  64.962 &lt; 0.0000000000000002 ***
as.factor(hour)9   0.3598210  0.0078159  46.037 &lt; 0.0000000000000002 ***
as.factor(hour)10  0.2460810  0.0076647  32.106 &lt; 0.0000000000000002 ***
as.factor(hour)11  0.2676516  0.0077151  34.692 &lt; 0.0000000000000002 ***
as.factor(hour)12  0.3345613  0.0077972  42.908 &lt; 0.0000000000000002 ***
as.factor(hour)13  0.3335884  0.0078885  42.288 &lt; 0.0000000000000002 ***
as.factor(hour)14  0.3298815  0.0076963  42.862 &lt; 0.0000000000000002 ***
as.factor(hour)15  0.3889267  0.0077546  50.155 &lt; 0.0000000000000002 ***
as.factor(hour)16  0.4812228  0.0077566  62.041 &lt; 0.0000000000000002 ***
as.factor(hour)17  0.5848969  0.0077931  75.053 &lt; 0.0000000000000002 ***
as.factor(hour)18  0.4003396  0.0075825  52.798 &lt; 0.0000000000000002 ***
as.factor(hour)19  0.2521779  0.0077095  32.710 &lt; 0.0000000000000002 ***
as.factor(hour)20  0.1373139  0.0074848  18.346 &lt; 0.0000000000000002 ***
as.factor(hour)21  0.0880114  0.0075923  11.592 &lt; 0.0000000000000002 ***
as.factor(hour)22  0.0580815  0.0076060   7.636   0.0000000000000224 ***
as.factor(hour)23  0.0350222  0.0076227   4.594   0.0000043403255736 ***
dotw_simple2       0.0651434  0.0043665  14.919 &lt; 0.0000000000000002 ***
dotw_simple3       0.0430540  0.0043119   9.985 &lt; 0.0000000000000002 ***
dotw_simple4       0.0505750  0.0041306  12.244 &lt; 0.0000000000000002 ***
dotw_simple5       0.0434119  0.0041584  10.440 &lt; 0.0000000000000002 ***
dotw_simple6      -0.0672427  0.0042085 -15.978 &lt; 0.0000000000000002 ***
dotw_simple7      -0.0631357  0.0041631 -15.166 &lt; 0.0000000000000002 ***
Temperature        0.0069235  0.0001365  50.722 &lt; 0.0000000000000002 ***
Precipitation     -2.4416620  0.0939158 -25.998 &lt; 0.0000000000000002 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.7216 on 428368 degrees of freedom
Multiple R-squared:  0.07598,   Adjusted R-squared:  0.07592 
F-statistic:  1136 on 31 and 428368 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
<p>The model uses Monday as the baseline. Each coefficient represents the difference in expected trips per station-hour compared to Monday - dow_simple2 = Tuesday..</p>
<p><strong>Weekday Pattern (Tue-Fri):</strong></p>
<ul>
<li>All weekdays have positive coefficients (0.029 to 0.052)</li>
<li>Tuesday has the highest weekday effect (+0.052)</li>
<li>Weekdays likely benefit from concentrated commuting patterns</li>
</ul>
<p><strong>Weekend Pattern (Sat-Sun):</strong></p>
<ul>
<li>Both weekend days have negative coefficients (-0.061 and -0.065)</li>
<li>This means FEWER trips per station-hour than Monday</li>
</ul>
<p><strong>Hourly Interpretation</strong></p>
<p>Hour Coefficient Interpretation 0 (baseline) 0.000 trips/hour (midnight) 1 -0.018 slightly fewer than midnight … 6 +0.151 morning activity starting 7 +0.276 morning rush building 8 +0.487 PEAK morning rush 9 +0.350 post-rush … 17 +0.568 PEAK evening rush (5 PM!) 18 +0.389 evening declining … 23 +0.034 late night minimal</p>
<p>Isn’t this fun!</p>
</section>
<section id="model-2-add-temporal-lags" class="level2">
<h2 class="anchored" data-anchor-id="model-2-add-temporal-lags">Model 2: Add Temporal Lags</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation + lag1Hour + lag3Hours + lag1day, data = train)

Residuals:
    Min      1Q  Median      3Q     Max 
-5.1487 -0.2595 -0.0970  0.0235 17.5255 

Coefficients:
                    Estimate Std. Error t value             Pr(&gt;|t|)    
(Intercept)       -0.0944031  0.0069331 -13.616 &lt; 0.0000000000000002 ***
as.factor(hour)1  -0.0028329  0.0070412  -0.402             0.687436    
as.factor(hour)2  -0.0113676  0.0070205  -1.619             0.105403    
as.factor(hour)3  -0.0233665  0.0069984  -3.339             0.000841 ***
as.factor(hour)4  -0.0014341  0.0071021  -0.202             0.839977    
as.factor(hour)5   0.0463719  0.0071041   6.528 0.000000000066943682 ***
as.factor(hour)6   0.1484482  0.0070401  21.086 &lt; 0.0000000000000002 ***
as.factor(hour)7   0.2157558  0.0069815  30.904 &lt; 0.0000000000000002 ***
as.factor(hour)8   0.3617314  0.0069664  51.925 &lt; 0.0000000000000002 ***
as.factor(hour)9   0.1603371  0.0070640  22.698 &lt; 0.0000000000000002 ***
as.factor(hour)10  0.1024525  0.0069124  14.822 &lt; 0.0000000000000002 ***
as.factor(hour)11  0.1360277  0.0069632  19.535 &lt; 0.0000000000000002 ***
as.factor(hour)12  0.2021688  0.0070303  28.757 &lt; 0.0000000000000002 ***
as.factor(hour)13  0.1900074  0.0071126  26.714 &lt; 0.0000000000000002 ***
as.factor(hour)14  0.1963837  0.0069380  28.305 &lt; 0.0000000000000002 ***
as.factor(hour)15  0.2435050  0.0069932  34.820 &lt; 0.0000000000000002 ***
as.factor(hour)16  0.3042270  0.0070018  43.450 &lt; 0.0000000000000002 ***
as.factor(hour)17  0.3749605  0.0070436  53.234 &lt; 0.0000000000000002 ***
as.factor(hour)18  0.1792367  0.0068606  26.126 &lt; 0.0000000000000002 ***
as.factor(hour)19  0.0973764  0.0069608  13.989 &lt; 0.0000000000000002 ***
as.factor(hour)20  0.0389727  0.0067549   5.770 0.000000007955345969 ***
as.factor(hour)21  0.0320507  0.0068394   4.686 0.000002784344470639 ***
as.factor(hour)22  0.0310219  0.0068459   4.531 0.000005859991631025 ***
as.factor(hour)23  0.0221611  0.0068594   3.231             0.001235 ** 
dotw_simple2       0.0271522  0.0039314   6.907 0.000000000004972450 ***
dotw_simple3       0.0147801  0.0038816   3.808             0.000140 ***
dotw_simple4       0.0206099  0.0037187   5.542 0.000000029877813199 ***
dotw_simple5       0.0127648  0.0037443   3.409             0.000652 ***
dotw_simple6      -0.0521272  0.0037909 -13.750 &lt; 0.0000000000000002 ***
dotw_simple7      -0.0303227  0.0037485  -8.089 0.000000000000000602 ***
Temperature        0.0029026  0.0001236  23.486 &lt; 0.0000000000000002 ***
Precipitation     -1.3850445  0.0846392 -16.364 &lt; 0.0000000000000002 ***
lag1Hour           0.3247918  0.0014556 223.135 &lt; 0.0000000000000002 ***
lag3Hours          0.0975134  0.0014354  67.936 &lt; 0.0000000000000002 ***
lag1day            0.1659090  0.0013907 119.300 &lt; 0.0000000000000002 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.6493 on 428365 degrees of freedom
Multiple R-squared:  0.2519,    Adjusted R-squared:  0.2518 
F-statistic:  4241 on 34 and 428365 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
<p><strong>Question:</strong> Did adding lags improve R²? Why or why not? I believe adding lags improved the model for two main reasons. Primarily, lags improve the theoretical aspects of the model, as I believe ridership — especially in the previous hour and day — are incredibly related to expected ridership of the hour we hope to estimate. Furthermore, this theoretical connection is found in the slightly improved R2. Whilst R2 is not the end all be all, the increase from .07 to .25 is extremely notable.</p>
</section>
<section id="model-3-add-demographics" class="level2">
<h2 class="anchored" data-anchor-id="model-3-add-demographics">Model 3: Add Demographics</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day <span class="sc">+</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    Med_Inc.x <span class="sc">+</span> Percent_Taking_Transit.y <span class="sc">+</span> Percent_White.y,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model3)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation + lag1Hour + lag3Hours + lag1day + Med_Inc.x + 
    Percent_Taking_Transit.y + Percent_White.y, data = train)

Residuals:
    Min      1Q  Median      3Q     Max 
-4.0188 -0.4829 -0.2267  0.2771 16.9058 

Coefficients:
                              Estimate    Std. Error t value
(Intercept)               0.9225844734  0.0352000581  26.210
as.factor(hour)1          0.0037772168  0.0441610229   0.086
as.factor(hour)2         -0.0955075476  0.0487102008  -1.961
as.factor(hour)3         -0.1340354597  0.0623637654  -2.149
as.factor(hour)4         -0.1416017281  0.0554770480  -2.552
as.factor(hour)5         -0.1300062643  0.0388982897  -3.342
as.factor(hour)6          0.0360772463  0.0331031436   1.090
as.factor(hour)7          0.1328270695  0.0317248940   4.187
as.factor(hour)8          0.3866084171  0.0308539302  12.530
as.factor(hour)9         -0.0445315405  0.0310696933  -1.433
as.factor(hour)10        -0.0847033567  0.0313859062  -2.699
as.factor(hour)11        -0.0290106009  0.0314061584  -0.924
as.factor(hour)12         0.0385416417  0.0310913865   1.240
as.factor(hour)13         0.0421197178  0.0311715057   1.351
as.factor(hour)14         0.0117664453  0.0307921034   0.382
as.factor(hour)15         0.0826672722  0.0306447205   2.698
as.factor(hour)16         0.1940771623  0.0304962350   6.364
as.factor(hour)17         0.3048041726  0.0304046610  10.025
as.factor(hour)18         0.0002652992  0.0305035090   0.009
as.factor(hour)19        -0.0634666243  0.0312457890  -2.031
as.factor(hour)20        -0.1392336862  0.0318719442  -4.369
as.factor(hour)21        -0.1321162902  0.0327955752  -4.028
as.factor(hour)22        -0.1054260206  0.0336780868  -3.130
as.factor(hour)23        -0.0569114464  0.0351511626  -1.619
dotw_simple2              0.0229986016  0.0122313741   1.880
dotw_simple3             -0.0175461556  0.0122262223  -1.435
dotw_simple4             -0.0442688138  0.0115791517  -3.823
dotw_simple5              0.0027339310  0.0117287820   0.233
dotw_simple6             -0.1108106236  0.0125102844  -8.858
dotw_simple7             -0.0398429023  0.0126913144  -3.139
Temperature               0.0039381085  0.0003773197  10.437
Precipitation            -4.4263561137  0.3064039720 -14.446
lag1Hour                  0.2204571054  0.0028934647  76.191
lag3Hours                 0.0583071946  0.0031516027  18.501
lag1day                   0.1447413119  0.0029839179  48.507
Med_Inc.x                 0.0000004207  0.0000001117   3.767
Percent_Taking_Transit.y -0.0011705604  0.0004209381  -2.781
Percent_White.y           0.0018451795  0.0002099438   8.789
                                     Pr(&gt;|t|)    
(Intercept)              &lt; 0.0000000000000002 ***
as.factor(hour)1                     0.931838    
as.factor(hour)2                     0.049914 *  
as.factor(hour)3                     0.031617 *  
as.factor(hour)4                     0.010699 *  
as.factor(hour)5                     0.000832 ***
as.factor(hour)6                     0.275785    
as.factor(hour)7               0.000028315277 ***
as.factor(hour)8         &lt; 0.0000000000000002 ***
as.factor(hour)9                     0.151782    
as.factor(hour)10                    0.006961 ** 
as.factor(hour)11                    0.355633    
as.factor(hour)12                    0.215118    
as.factor(hour)13                    0.176627    
as.factor(hour)14                    0.702369    
as.factor(hour)15                    0.006985 ** 
as.factor(hour)16              0.000000000198 ***
as.factor(hour)17        &lt; 0.0000000000000002 ***
as.factor(hour)18                    0.993061    
as.factor(hour)19                    0.042237 *  
as.factor(hour)20              0.000012523294 ***
as.factor(hour)21              0.000056188260 ***
as.factor(hour)22                    0.001746 ** 
as.factor(hour)23                    0.105441    
dotw_simple2                         0.060071 .  
dotw_simple3                         0.151255    
dotw_simple4                         0.000132 ***
dotw_simple5                         0.815688    
dotw_simple6             &lt; 0.0000000000000002 ***
dotw_simple7                         0.001694 ** 
Temperature              &lt; 0.0000000000000002 ***
Precipitation            &lt; 0.0000000000000002 ***
lag1Hour                 &lt; 0.0000000000000002 ***
lag3Hours                &lt; 0.0000000000000002 ***
lag1day                  &lt; 0.0000000000000002 ***
Med_Inc.x                            0.000165 ***
Percent_Taking_Transit.y             0.005423 ** 
Percent_White.y          &lt; 0.0000000000000002 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.9136 on 83854 degrees of freedom
  (344508 observations deleted due to missingness)
Multiple R-squared:  0.1706,    Adjusted R-squared:  0.1702 
F-statistic:   466 on 37 and 83854 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
</section>
<section id="model-4-add-station-fixed-effects" class="level2">
<h2 class="anchored" data-anchor-id="model-4-add-station-fixed-effects">Model 4: Add Station Fixed Effects</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day <span class="sc">+</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    Med_Inc.x <span class="sc">+</span> Percent_Taking_Transit.y <span class="sc">+</span> Percent_White.y <span class="sc">+</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(start_station),</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary too long with all station dummies, just show key metrics</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 4 R-squared:"</span>, <span class="fu">summary</span>(model4)<span class="sc">$</span>r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 4 R-squared: 0.1922707 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 4 Adj R-squared:"</span>, <span class="fu">summary</span>(model4)<span class="sc">$</span>adj.r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 4 Adj R-squared: 0.1896529 </code></pre>
</div>
</div>
<p><strong>What do station fixed effects capture?</strong> Baseline differences in demand across stations (some are just busier than others!).</p>
</section>
<section id="model-5-add-rush-hour-interaction" class="level2">
<h2 class="anchored" data-anchor-id="model-5-add-rush-hour-interaction">Model 5: Add Rush Hour Interaction</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>model5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day <span class="sc">+</span> rush_hour <span class="sc">+</span> <span class="fu">as.factor</span>(month) <span class="sc">+</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    Med_Inc.x <span class="sc">+</span> Percent_Taking_Transit.y <span class="sc">+</span> Percent_White.y <span class="sc">+</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(start_station) <span class="sc">+</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    rush_hour <span class="sc">*</span> weekend,  <span class="co"># Rush hour effects different on weekends</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 5 R-squared:"</span>, <span class="fu">summary</span>(model5)<span class="sc">$</span>r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 5 R-squared: 0.1968772 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 5 Adj R-squared:"</span>, <span class="fu">summary</span>(model5)<span class="sc">$</span>adj.r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 5 Adj R-squared: 0.1942455 </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="model-evaluation" class="level1">
<h1>Model Evaluation</h1>
<section id="calculate-predictions-and-mae" class="level2">
<h2 class="anchored" data-anchor-id="calculate-predictions-and-mae">Calculate Predictions and MAE</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions on test set</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create day of week factor with treatment (dummy) coding</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dotw_simple =</span> <span class="fu">factor</span>(dotw, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>, <span class="st">"Sat"</span>, <span class="st">"Sun"</span>)))</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set contrasts to treatment coding (dummy variables)</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(test<span class="sc">$</span>dotw_simple) <span class="ot">&lt;-</span> <span class="fu">contr.treatment</span>(<span class="dv">7</span>)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred1 =</span> <span class="fu">predict</span>(model1, <span class="at">newdata =</span> test),</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred2 =</span> <span class="fu">predict</span>(model2, <span class="at">newdata =</span> test),</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred3 =</span> <span class="fu">predict</span>(model3, <span class="at">newdata =</span> test),</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred4 =</span> <span class="fu">predict</span>(model4, <span class="at">newdata =</span> test),</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred5 =</span> <span class="fu">predict</span>(model5, <span class="at">newdata =</span> test)</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate MAE for each model</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>mae_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1. Time + Weather"</span>,</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2. + Temporal Lags"</span>,</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"3. + Demographics"</span>,</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4. + Station FE"</span>,</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5. + Rush Hour Interaction"</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE =</span> <span class="fu">c</span>(</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred1), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred2), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred3), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred4), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred5), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(mae_results, </span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">digits =</span> <span class="dv">2</span>,</span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Mean Absolute Error by Model (Test Set)"</span>,</span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"MAE (trips)"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small">
<caption>Mean Absolute Error by Model (Test Set)</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MAE (trips)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1. Time + Weather</td>
<td style="text-align: right;">0.60</td>
</tr>
<tr class="even">
<td style="text-align: left;">2. + Temporal Lags</td>
<td style="text-align: right;">0.50</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3. + Demographics</td>
<td style="text-align: right;">0.74</td>
</tr>
<tr class="even">
<td style="text-align: left;">4. + Station FE</td>
<td style="text-align: right;">0.73</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5. + Rush Hour Interaction</td>
<td style="text-align: right;">0.73</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="visualize-model-comparison" class="level2">
<h2 class="anchored" data-anchor-id="visualize-model-comparison">Visualize Model Comparison</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mae_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Model, <span class="sc">-</span>MAE), <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"#3182bd"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(MAE, <span class="dv">2</span>)), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Performance Comparison"</span>,</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Lower MAE = Better Predictions"</span>,</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Model"</span>,</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean Absolute Error (trips)"</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  plotTheme <span class="sc">+</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/compare_models-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Question:</strong> Which features gave us the biggest improvement?</p>
<p>The temporal lag model recorded the least mean absolute error, illustrating that perhaps recent ridership is the best predicting factor for future ridership. This makes some sense, as recent ridership inherently takes into account the time/weather, rush hour, demographics, and the qualities of the station via the <em>free market of riders</em>.</p>
<hr>
</section>
</section>
<section id="space-time-error-analysis" class="level1">
<h1>Space-Time Error Analysis</h1>
<section id="observed-vs.-predicted" class="level2">
<h2 class="anchored" data-anchor-id="observed-vs.-predicted">Observed vs.&nbsp;Predicted</h2>
<p>Let’s use our best model (Model 2) for error analysis.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> Trip_Count <span class="sc">-</span> pred2,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_error =</span> <span class="fu">abs</span>(error),</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_of_day =</span> <span class="fu">case_when</span>(</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&lt;</span> <span class="dv">7</span> <span class="sc">~</span> <span class="st">"Overnight"</span>,</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;=</span> <span class="dv">7</span> <span class="sc">&amp;</span> hour <span class="sc">&lt;</span> <span class="dv">10</span> <span class="sc">~</span> <span class="st">"AM Rush"</span>,</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;=</span> <span class="dv">10</span> <span class="sc">&amp;</span> hour <span class="sc">&lt;</span> <span class="dv">15</span> <span class="sc">~</span> <span class="st">"Mid-Day"</span>,</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;=</span> <span class="dv">15</span> <span class="sc">&amp;</span> hour <span class="sc">&lt;=</span> <span class="dv">18</span> <span class="sc">~</span> <span class="st">"PM Rush"</span>,</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;</span> <span class="dv">18</span> <span class="sc">~</span> <span class="st">"Evening"</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot by time and day type</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test, <span class="fu">aes</span>(<span class="at">x =</span> Trip_Count, <span class="at">y =</span> pred2)) <span class="sc">+</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(weekend <span class="sc">~</span> time_of_day) <span class="sc">+</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Observed vs. Predicted Bike Trips"</span>,</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Model 2 performance by time period"</span>,</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Observed Trips"</span>,</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Trips"</span>,</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Red line = perfect predictions; Green line = actual model fit"</span></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/obs_vs_pred-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Question:</strong> Where is the model performing well? Where is it struggling? The model appears to preforms best for the AM rush and evening for weekdays as well as for the PM rush on both weekdays and weekends. The model struggles the most at midday for both weekdays and weekends. Performance is measured by relative alignment to the <em>perfect predictions</em> line.</p>
</section>
<section id="spatial-error-patterns" class="level2">
<h2 class="anchored" data-anchor-id="spatial-error-patterns">Spatial Error Patterns</h2>
<p>Are prediction errors clustered in certain parts of Philadelphia?</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate MAE by station</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>station_errors <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station, start_lat.x, start_lon.y) <span class="sc">%&gt;%</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(abs_error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_demand =</span> <span class="fu">mean</span>(Trip_Count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat.x), <span class="sc">!</span><span class="fu">is.na</span>(start_lon.y))</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Create Two Maps Side-by-Side with Proper Legends (sorry these maps are ugly)</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate station errors</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>station_errors <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred2)) <span class="sc">%&gt;%</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station, start_lat.x, start_lon.y) <span class="sc">%&gt;%</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(Trip_Count <span class="sc">-</span> pred2), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_demand =</span> <span class="fu">mean</span>(Trip_Count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat.x), <span class="sc">!</span><span class="fu">is.na</span>(start_lon.y))</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 1: Prediction Errors</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> MAE),</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"plasma"</span>,</span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"MAE</span><span class="sc">\n</span><span class="st">(trips)"</span>,</span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>),  <span class="co"># Fewer, cleaner breaks</span></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>)</span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prediction Errors"</span>,</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Higher in Center City"</span>) <span class="sc">+</span></span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="fl">1.5</span>,</span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">12</span>,</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 2: Average Demand</span></span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> avg_demand),</span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Avg</span><span class="sc">\n</span><span class="st">Demand"</span>,</span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.0</span>, <span class="fl">2.5</span>),  <span class="co"># Clear breaks</span></span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>, <span class="st">"2.0"</span>, <span class="st">"2.5"</span>)</span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Average Demand"</span>,</span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Trips per station-hour"</span>) <span class="sc">+</span></span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb80-80"><a href="#cb80-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb80-81"><a href="#cb80-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb80-82"><a href="#cb80-82" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-83"><a href="#cb80-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb80-84"><a href="#cb80-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="fl">1.5</span>,</span>
<span id="cb80-85"><a href="#cb80-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">12</span>,</span>
<span id="cb80-86"><a href="#cb80-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb80-87"><a href="#cb80-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb80-88"><a href="#cb80-88" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb80-89"><a href="#cb80-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-90"><a href="#cb80-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine with better layout</span></span>
<span id="cb80-91"><a href="#cb80-91" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb80-92"><a href="#cb80-92" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grid)</span>
<span id="cb80-93"><a href="#cb80-93" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(</span>
<span id="cb80-94"><a href="#cb80-94" aria-hidden="true" tabindex="-1"></a>  p1, p2, </span>
<span id="cb80-95"><a href="#cb80-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">2</span>,</span>
<span id="cb80-96"><a href="#cb80-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">top =</span> <span class="fu">textGrob</span>(</span>
<span id="cb80-97"><a href="#cb80-97" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Model 2 Performance: Errors vs. Demand Patterns"</span>,</span>
<span id="cb80-98"><a href="#cb80-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">16</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>)</span>
<span id="cb80-99"><a href="#cb80-99" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-100"><a href="#cb80-100" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/spatial_errors-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 1: Prediction Errors</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> MAE),</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"plasma"</span>,</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"MAE (trips)"</span>,</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>),</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>)</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prediction Errors"</span>) <span class="sc">+</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="dv">12</span>,</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">1</span>,</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 2: Average Demand  </span></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> avg_demand),</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Avg Demand (trips/hour)"</span>,</span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.0</span>, <span class="fl">2.5</span>),</span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>, <span class="st">"2.0"</span>, <span class="st">"2.5"</span>)</span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Average Demand"</span>) <span class="sc">+</span></span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="dv">12</span>,</span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">1</span>,</span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb81-61"><a href="#cb81-61" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb81-62"><a href="#cb81-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine</span></span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(</span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a>  p1, p2,</span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb81-67"><a href="#cb81-67" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/spatial_errors-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/spatial_errors-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Question:</strong> Do you see spatial clustering of errors? What neighborhoods have high errors? There is a cluster of errosr along the the Schuykill River as it passes through Manayunk and East Falls, the western end of Center City, as well as along the Delaware River (Society Hill?). The errors seem to mimic stations/areas that have higher than average “average trips/hour”.</p>
</section>
<section id="temporal-error-patterns" class="level2">
<h2 class="anchored" data-anchor-id="temporal-error-patterns">Temporal Error Patterns</h2>
<p>When are we most wrong?</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MAE by time of day and day type</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>temporal_errors <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(time_of_day, weekend) <span class="sc">%&gt;%</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(abs_error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day_type =</span> <span class="fu">ifelse</span>(weekend <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>))</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(temporal_errors, <span class="fu">aes</span>(<span class="at">x =</span> time_of_day, <span class="at">y =</span> MAE, <span class="at">fill =</span> day_type)) <span class="sc">+</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> <span class="st">"#08519c"</span>, <span class="st">"Weekend"</span> <span class="ot">=</span> <span class="st">"#6baed6"</span>)) <span class="sc">+</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Errors by Time Period"</span>,</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"When is the model struggling most?"</span>,</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time of Day"</span>,</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean Absolute Error (trips)"</span>,</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Day Type"</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>  plotTheme <span class="sc">+</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/temporal_errors-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="errors-and-demographics" class="level2">
<h2 class="anchored" data-anchor-id="errors-and-demographics">Errors and Demographics</h2>
<p>Are prediction errors related to neighborhood characteristics?</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join demographic data to station errors</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>station_errors_demo <span class="ot">&lt;-</span> station_errors <span class="sc">%&gt;%</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    station_attributes <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_station, Med_Inc, Percent_Taking_Transit, Percent_White),</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Med_Inc))</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create plots</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(station_errors_demo, <span class="fu">aes</span>(<span class="at">x =</span> Med_Inc, <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Errors vs. Median Income"</span>, <span class="at">x =</span> <span class="st">"Median Income"</span>, <span class="at">y =</span> <span class="st">"MAE"</span>) <span class="sc">+</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(station_errors_demo, <span class="fu">aes</span>(<span class="at">x =</span> Percent_Taking_Transit, <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Errors vs. Transit Usage"</span>, <span class="at">x =</span> <span class="st">"% Taking Transit"</span>, <span class="at">y =</span> <span class="st">"MAE"</span>) <span class="sc">+</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(station_errors_demo, <span class="fu">aes</span>(<span class="at">x =</span> Percent_White, <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Errors vs. Race"</span>, <span class="at">x =</span> <span class="st">"% White"</span>, <span class="at">y =</span> <span class="st">"MAE"</span>) <span class="sc">+</span></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, p3, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/errors_demographics-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Critical Question:</strong> Are prediction errors systematically higher in certain demographic groups? What are the equity implications?</p>
</section>
<section id="prediciton-error-has-a-postive-trend-with-an-increase-in-both-median-income-and-percentage-of-white-residents.-error-also-negative-relationship-with-transit-ridership.-whiter-wealthier-areas-of-the-city-tend-to-be-denser-and-near-center-city-or-other-economic-hub-which-are-where-indego-stations-are-more-densely-located.-it-could-be-thought-that-wealthier-and-whiter-areas-of-the-city-have-greater-options-when-deciding-which-indego-bike-station-to-use-whereas-more-diverse-and-poorer-areas-of-the-city-have-limited-options-if-any-at-all." class="level2">
<h2 class="anchored" data-anchor-id="prediciton-error-has-a-postive-trend-with-an-increase-in-both-median-income-and-percentage-of-white-residents.-error-also-negative-relationship-with-transit-ridership.-whiter-wealthier-areas-of-the-city-tend-to-be-denser-and-near-center-city-or-other-economic-hub-which-are-where-indego-stations-are-more-densely-located.-it-could-be-thought-that-wealthier-and-whiter-areas-of-the-city-have-greater-options-when-deciding-which-indego-bike-station-to-use-whereas-more-diverse-and-poorer-areas-of-the-city-have-limited-options-if-any-at-all.">Prediciton error has a postive trend with an increase in both median income and percentage of white residents. Error also negative relationship with transit ridership. Whiter, wealthier areas of the city tend to be denser and near center city or other economic hub, which are where Indego stations are more densely located. It could be thought that wealthier and whiter areas of the city have greater options when deciding which Indego bike station to use, whereas more diverse and poorer areas of the city have limited options if any at all.</h2>
</section>
</section>
<section id="hw5-your-turn" class="level1">
<h1>HW5: Your Turn!</h1>
<p>For Homework 5, you’ll work either all byyyy yourself or in teams of 2 to:</p>
<section id="part-1-replicate-with-different-quarter-alternately-you-could-do-a-longer-time-span-by-merging-multiple-quarters-together.-im-not-picky-about-that" class="level2">
<h2 class="anchored" data-anchor-id="part-1-replicate-with-different-quarter-alternately-you-could-do-a-longer-time-span-by-merging-multiple-quarters-together.-im-not-picky-about-that">Part 1: Replicate with Different Quarter (alternately, you could do a longer time-span by merging multiple quarters together. I’m not picky about that)</h2>
<p>I chose Q2 of 2025 because the weather will be warmer but not too warm to bike.</p>
<hr>
</section>
</section>
<section id="data-import-preparation-1" class="level1">
<h1>Data Import &amp; Preparation</h1>
<section id="load-indego-trip-data-q2-2025" class="level2">
<h2 class="anchored" data-anchor-id="load-indego-trip-data-q2-2025">Load Indego Trip Data (Q2 2025)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co">#get current directory (not same as project home)</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read Q2 2025 data</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>indego <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"data/indego-trips-2025-q2.csv"</span>))</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick look at the data</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(indego)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 365,760
Columns: 15
$ trip_id             &lt;dbl&gt; 1164246461, 1164246634, 1164246553, 1164246521, 11…
$ duration            &lt;dbl&gt; 11, 31, 9, 3, 11, 7, 13, 12, 3, 58, 21, 5, 15, 10,…
$ start_time          &lt;chr&gt; "4/1/2025 0:04", "4/1/2025 0:04", "4/1/2025 0:17",…
$ end_time            &lt;chr&gt; "4/1/2025 0:15", "4/1/2025 0:35", "4/1/2025 0:26",…
$ start_station       &lt;dbl&gt; 3022, 3040, 3396, 3054, 3280, 3301, 3158, 3374, 33…
$ start_lat           &lt;dbl&gt; 39.95472, 39.96289, 39.92327, 39.96250, 39.93968, …
$ start_lon           &lt;dbl&gt; -75.18323, -75.16606, -75.18210, -75.17420, -75.21…
$ end_station         &lt;dbl&gt; 3064, 3100, 3349, 3235, 3349, 3051, 3028, 3154, 33…
$ end_lat             &lt;dbl&gt; 39.93840, 39.92777, 39.93651, 39.96000, 39.93651, …
$ end_lon             &lt;dbl&gt; -75.17327, -75.15103, -75.18621, -75.16510, -75.18…
$ bike_id             &lt;chr&gt; "31751", "14481", "02724", "24841", "25744", "3123…
$ plan_duration       &lt;dbl&gt; 30, 30, 30, 365, 30, 365, 1, 30, 30, 30, 30, 30, 1…
$ trip_route_category &lt;chr&gt; "One Way", "One Way", "One Way", "One Way", "One W…
$ passholder_type     &lt;chr&gt; "Indego30", "Indego30", "Indego30", "Indego365", "…
$ bike_type           &lt;chr&gt; "electric", "standard", "standard", "electric", "e…</code></pre>
</div>
</div>
</section>
<section id="examine-the-data-structure-1" class="level2">
<h2 class="anchored" data-anchor-id="examine-the-data-structure-1">Examine the Data Structure</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many trips?</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total trips in Q1 2025:"</span>, <span class="fu">nrow</span>(indego), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total trips in Q1 2025: 365760 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Date range</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Date range:"</span>, </span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">min</span>(<span class="fu">mdy_hm</span>(indego<span class="sc">$</span>start_time)), <span class="st">"to"</span>, </span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">max</span>(<span class="fu">mdy_hm</span>(indego<span class="sc">$</span>start_time)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Date range: 1743465840 to 1751327820 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many unique stations?</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Unique start stations:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(indego<span class="sc">$</span>start_station)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Unique start stations: 273 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Trip types</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(indego<span class="sc">$</span>trip_route_category)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   One Way Round Trip 
    341060      24700 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Passholder types</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(indego<span class="sc">$</span>passholder_type)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  Day Pass   Indego30  Indego365 IndegoFlex       NULL    Walk-up 
     15712     189135     132693          1          4      28215 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bike types</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(indego<span class="sc">$</span>bike_type)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
electric standard 
  234502   131258 </code></pre>
</div>
</div>
</section>
<section id="create-time-bins-1" class="level2">
<h2 class="anchored" data-anchor-id="create-time-bins-1">Create Time Bins</h2>
<p>We need to aggregate trips into hourly intervals for our panel data structure.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>indego <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse datetime</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_datetime =</span> <span class="fu">mdy_hm</span>(start_time),</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_datetime =</span> <span class="fu">mdy_hm</span>(end_time),</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create hourly bins</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">interval60 =</span> <span class="fu">floor_date</span>(start_datetime, <span class="at">unit =</span> <span class="st">"hour"</span>),</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract time features</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">week =</span> <span class="fu">week</span>(interval60),</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">dotw =</span> <span class="fu">wday</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">hour =</span> <span class="fu">hour</span>(interval60),</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(interval60),</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create useful indicators</span></span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekend =</span> <span class="fu">ifelse</span>(dotw <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">rush_hour =</span> <span class="fu">ifelse</span>(hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at temporal features</span></span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(indego <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_datetime, interval60, week, dotw, hour, weekend))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  start_datetime      interval60           week dotw   hour weekend
  &lt;dttm&gt;              &lt;dttm&gt;              &lt;dbl&gt; &lt;ord&gt; &lt;int&gt;   &lt;dbl&gt;
1 2025-04-01 00:04:00 2025-04-01 00:00:00    13 Tue       0       0
2 2025-04-01 00:04:00 2025-04-01 00:00:00    13 Tue       0       0
3 2025-04-01 00:17:00 2025-04-01 00:00:00    13 Tue       0       0
4 2025-04-01 00:20:00 2025-04-01 00:00:00    13 Tue       0       0
5 2025-04-01 00:25:00 2025-04-01 00:00:00    13 Tue       0       0
6 2025-04-01 00:40:00 2025-04-01 00:00:00    13 Tue       0       0</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="exploratory-analysis-1" class="level1">
<h1>Exploratory Analysis</h1>
<section id="trips-over-time-1" class="level2">
<h2 class="anchored" data-anchor-id="trips-over-time-1">Trips Over Time</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily trip counts</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>daily_trips <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">trips =</span> <span class="fu">n</span>())</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(daily_trips, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> trips)) <span class="sc">+</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#3182bd"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Indego Daily Ridership - Q1 2025"</span>,</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Winter demand patterns in Philadelphia"</span>,</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Daily Trips"</span>,</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Indego bike share"</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/trips_over_time2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hourly-patterns-1" class="level2">
<h2 class="anchored" data-anchor-id="hourly-patterns-1">Hourly Patterns</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Average trips by hour and day type</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>hourly_patterns <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hour, weekend) <span class="sc">%&gt;%</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">avg_trips =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="fu">n_distinct</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day_type =</span> <span class="fu">ifelse</span>(weekend <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>))</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hourly_patterns, <span class="fu">aes</span>(<span class="at">x =</span> hour, <span class="at">y =</span> avg_trips, <span class="at">color =</span> day_type)) <span class="sc">+</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> <span class="st">"#08519c"</span>, <span class="st">"Weekend"</span> <span class="ot">=</span> <span class="st">"#6baed6"</span>)) <span class="sc">+</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Average Hourly Ridership Patterns"</span>,</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Clear commute patterns on weekdays"</span>,</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Hour of Day"</span>,</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Trips per Hour"</span>,</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Day Type"</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/hourly_patterns2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="top-stations" class="level2">
<h2 class="anchored" data-anchor-id="top-stations">Top Stations</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Most popular origin stations</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>top_stations <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(start_station, start_lat, start_lon, <span class="at">name =</span> <span class="st">"trips"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(trips)) <span class="sc">%&gt;%</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">20</span>)</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(top_stations, </span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Top 20 Indego Stations by Trip Origins"</span>,</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small">
<caption>Top 20 Indego Stations by Trip Origins</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">start_station</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">start_lat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">start_lon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">trips</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">3,010</td>
<td style="text-align: right;">39.94711</td>
<td style="text-align: right;">-75.16618</td>
<td style="text-align: right;">6,278</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,032</td>
<td style="text-align: right;">39.94527</td>
<td style="text-align: right;">-75.17971</td>
<td style="text-align: right;">4,751</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,359</td>
<td style="text-align: right;">39.94888</td>
<td style="text-align: right;">-75.16978</td>
<td style="text-align: right;">4,181</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,028</td>
<td style="text-align: right;">39.94061</td>
<td style="text-align: right;">-75.14958</td>
<td style="text-align: right;">4,028</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,163</td>
<td style="text-align: right;">39.94974</td>
<td style="text-align: right;">-75.18097</td>
<td style="text-align: right;">4,000</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,020</td>
<td style="text-align: right;">39.94855</td>
<td style="text-align: right;">-75.19007</td>
<td style="text-align: right;">3,946</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,185</td>
<td style="text-align: right;">39.95169</td>
<td style="text-align: right;">-75.15888</td>
<td style="text-align: right;">3,914</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,066</td>
<td style="text-align: right;">39.94561</td>
<td style="text-align: right;">-75.17348</td>
<td style="text-align: right;">3,899</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,022</td>
<td style="text-align: right;">39.95472</td>
<td style="text-align: right;">-75.18323</td>
<td style="text-align: right;">3,856</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,054</td>
<td style="text-align: right;">39.96250</td>
<td style="text-align: right;">-75.17420</td>
<td style="text-align: right;">3,767</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,161</td>
<td style="text-align: right;">39.95486</td>
<td style="text-align: right;">-75.18091</td>
<td style="text-align: right;">3,629</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,362</td>
<td style="text-align: right;">39.94816</td>
<td style="text-align: right;">-75.16226</td>
<td style="text-align: right;">3,552</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,063</td>
<td style="text-align: right;">39.94633</td>
<td style="text-align: right;">-75.16980</td>
<td style="text-align: right;">3,516</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,213</td>
<td style="text-align: right;">39.93887</td>
<td style="text-align: right;">-75.16663</td>
<td style="text-align: right;">3,332</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,059</td>
<td style="text-align: right;">39.96244</td>
<td style="text-align: right;">-75.16121</td>
<td style="text-align: right;">3,320</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,012</td>
<td style="text-align: right;">39.94218</td>
<td style="text-align: right;">-75.17747</td>
<td style="text-align: right;">3,264</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,007</td>
<td style="text-align: right;">39.94517</td>
<td style="text-align: right;">-75.15993</td>
<td style="text-align: right;">3,242</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,061</td>
<td style="text-align: right;">39.95425</td>
<td style="text-align: right;">-75.17761</td>
<td style="text-align: right;">3,193</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,101</td>
<td style="text-align: right;">39.94295</td>
<td style="text-align: right;">-75.15955</td>
<td style="text-align: right;">3,170</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,296</td>
<td style="text-align: right;">39.95134</td>
<td style="text-align: right;">-75.16758</td>
<td style="text-align: right;">3,088</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
</section>
<section id="get-philadelphia-spatial-context-1" class="level1">
<h1>Get Philadelphia Spatial Context</h1>
<section id="load-philadelphia-census-data-1" class="level2">
<h2 class="anchored" data-anchor-id="load-philadelphia-census-data-1">Load Philadelphia Census Data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get Philadelphia census tracts</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>philly_census <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">geography =</span> <span class="st">"tract"</span>,</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="fu">c</span>(</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B01003_001"</span>,  <span class="co"># Total population</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B19013_001"</span>,  <span class="co"># Median household income</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B08301_001"</span>,  <span class="co"># Total commuters</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B08301_010"</span>,  <span class="co"># Commute by transit</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B02001_002"</span>,  <span class="co"># White alone</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B25077_001"</span>   <span class="co"># Median home value</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">state =</span> <span class="st">"PA"</span>,</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">county =</span> <span class="st">"Philadelphia"</span>,</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="dv">2022</span>,</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">geometry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="st">"wide"</span>,</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">progress =</span> <span class="cn">FALSE</span></span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Pop =</span> B01003_001E,</span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">Med_Inc =</span> B19013_001E,</span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Commuters =</span> B08301_001E,</span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">Transit_Commuters =</span> B08301_010E,</span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">White_Pop =</span> B02001_002E,</span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">Med_Home_Value =</span> B25077_001E</span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_Taking_Transit =</span> (Transit_Commuters <span class="sc">/</span> Total_Commuters) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_White =</span> (White_Pop <span class="sc">/</span> Total_Pop) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>)  <span class="co"># WGS84 for lat/lon matching</span></span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the data</span></span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(philly_census)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 408
Columns: 17
$ GEOID                  &lt;chr&gt; "42101001500", "42101001800", "42101002802", "4…
$ NAME                   &lt;chr&gt; "Census Tract 15; Philadelphia County; Pennsylv…
$ Total_Pop              &lt;dbl&gt; 3251, 3300, 5720, 4029, 4415, 1815, 3374, 2729,…
$ B01003_001M            &lt;dbl&gt; 677, 369, 796, 437, 853, 210, 480, 734, 763, 11…
$ Med_Inc                &lt;dbl&gt; 110859, 114063, 78871, 61583, 32347, 48581, 597…
$ B19013_001M            &lt;dbl&gt; 24975, 30714, 20396, 22293, 4840, 13812, 6278, …
$ Total_Commuters        &lt;dbl&gt; 2073, 2255, 3032, 2326, 1980, 969, 2427, 708, 2…
$ B08301_001M            &lt;dbl&gt; 387, 308, 478, 383, 456, 189, 380, 281, 456, 68…
$ Transit_Commuters      &lt;dbl&gt; 429, 123, 685, 506, 534, 192, 658, 218, 438, 51…
$ B08301_010M            &lt;dbl&gt; 188, 66, 219, 144, 285, 71, 278, 184, 176, 235,…
$ White_Pop              &lt;dbl&gt; 2185, 2494, 3691, 3223, 182, 984, 2111, 231, 35…
$ B02001_002M            &lt;dbl&gt; 268, 381, 592, 380, 88, 190, 463, 112, 238, 778…
$ Med_Home_Value         &lt;dbl&gt; 568300, 605000, 350600, 296400, 76600, 289700, …
$ B25077_001M            &lt;dbl&gt; 58894, 34876, 12572, 22333, 10843, 118720, 1506…
$ geometry               &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((-75.16558 3..., MU…
$ Percent_Taking_Transit &lt;dbl&gt; 20.694645, 5.454545, 22.592348, 21.754084, 26.9…
$ Percent_White          &lt;dbl&gt; 67.2100892, 75.5757576, 64.5279720, 79.9950360,…</code></pre>
</div>
</div>
</section>
<section id="map-philadelphia-context-1" class="level2">
<h2 class="anchored" data-anchor-id="map-philadelphia-context-1">Map Philadelphia Context</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Map median income</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="fu">aes</span>(<span class="at">fill =</span> Med_Inc), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Median</span><span class="sc">\n</span><span class="st">Income"</span>,</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span>dollar</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Philadelphia Median Household Income by Census Tract"</span>,</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Context for understanding bike share demand patterns"</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stations </span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> indego,</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon, <span class="at">y =</span> start_lat),</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.25</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>  mapTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/map_philly2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="join-census-data-to-stations-1" class="level2">
<h2 class="anchored" data-anchor-id="join-census-data-to-stations-1">Join Census Data to Stations</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sf object for stations</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>stations_sf <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station, start_lat, start_lon) <span class="sc">%&gt;%</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat), <span class="sc">!</span><span class="fu">is.na</span>(start_lon)) <span class="sc">%&gt;%</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"start_lon"</span>, <span class="st">"start_lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join to get census tract for each station</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>stations_census <span class="ot">&lt;-</span> <span class="fu">st_join</span>(stations_sf, philly_census, <span class="at">left =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the result - investigate whether all of the stations joined to census data -- according to the map above there are stations in non-residential tracts.</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>stations_for_map <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station, start_lat, start_lon) <span class="sc">%&gt;%</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat), <span class="sc">!</span><span class="fu">is.na</span>(start_lon)) <span class="sc">%&gt;%</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_station, Med_Inc),</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">has_census =</span> <span class="sc">!</span><span class="fu">is.na</span>(Med_Inc))</span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add back to trip data</span></span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>indego_census <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> </span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(start_station, Med_Inc, Percent_Taking_Transit, </span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a>             Percent_White, Total_Pop),</span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-32"><a href="#cb107-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for visualization</span></span>
<span id="cb107-33"><a href="#cb107-33" aria-hidden="true" tabindex="-1"></a>stations_for_map <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb107-34"><a href="#cb107-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station, start_lat, start_lon) <span class="sc">%&gt;%</span></span>
<span id="cb107-35"><a href="#cb107-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat), <span class="sc">!</span><span class="fu">is.na</span>(start_lon)) <span class="sc">%&gt;%</span></span>
<span id="cb107-36"><a href="#cb107-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb107-37"><a href="#cb107-37" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_station, Med_Inc),</span>
<span id="cb107-38"><a href="#cb107-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb107-39"><a href="#cb107-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb107-40"><a href="#cb107-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">has_census =</span> <span class="sc">!</span><span class="fu">is.na</span>(Med_Inc))</span>
<span id="cb107-41"><a href="#cb107-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-42"><a href="#cb107-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the map showing problem stations</span></span>
<span id="cb107-43"><a href="#cb107-43" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb107-44"><a href="#cb107-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="fu">aes</span>(<span class="at">fill =</span> Med_Inc), <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb107-45"><a href="#cb107-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb107-46"><a href="#cb107-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb107-47"><a href="#cb107-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Median</span><span class="sc">\n</span><span class="st">Income"</span>,</span>
<span id="cb107-48"><a href="#cb107-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span>dollar,</span>
<span id="cb107-49"><a href="#cb107-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">"grey90"</span></span>
<span id="cb107-50"><a href="#cb107-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb107-51"><a href="#cb107-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stations with census data (small grey dots)</span></span>
<span id="cb107-52"><a href="#cb107-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb107-53"><a href="#cb107-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stations_for_map <span class="sc">%&gt;%</span> <span class="fu">filter</span>(has_census),</span>
<span id="cb107-54"><a href="#cb107-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon, <span class="at">y =</span> start_lat),</span>
<span id="cb107-55"><a href="#cb107-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"grey30"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb107-56"><a href="#cb107-56" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb107-57"><a href="#cb107-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stations WITHOUT census data (red X marks the spot)</span></span>
<span id="cb107-58"><a href="#cb107-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb107-59"><a href="#cb107-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stations_for_map <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>has_census),</span>
<span id="cb107-60"><a href="#cb107-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon, <span class="at">y =</span> start_lat),</span>
<span id="cb107-61"><a href="#cb107-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">shape =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span></span>
<span id="cb107-62"><a href="#cb107-62" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb107-63"><a href="#cb107-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb107-64"><a href="#cb107-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Philadelphia Median Household Income by Census Tract"</span>,</span>
<span id="cb107-65"><a href="#cb107-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Indego stations shown (RED = no census data match)"</span>,</span>
<span id="cb107-66"><a href="#cb107-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Red X marks indicate stations that didn't join to census tracts"</span></span>
<span id="cb107-67"><a href="#cb107-67" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb107-68"><a href="#cb107-68" aria-hidden="true" tabindex="-1"></a>  mapTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/join_census_to_stations2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="dealing-with-missing-data-1" class="level1">
<h1>Dealing with missing data</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify which stations to keep</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>valid_stations <span class="ot">&lt;-</span> stations_census <span class="sc">%&gt;%</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Med_Inc)) <span class="sc">%&gt;%</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(start_station)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter trip data to valid stations only</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>indego_census <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(start_station <span class="sc">%in%</span> valid_stations) <span class="sc">%&gt;%</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> </span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(start_station, Med_Inc, Percent_Taking_Transit, </span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>             Percent_White, Total_Pop),</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="get-weather-data-1" class="level1">
<h1>Get Weather Data</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get weather from Philadelphia International Airport (KPHL)</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This covers Q1 2025: April 1 - June 30</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>weather_data <span class="ot">&lt;-</span> <span class="fu">riem_measures</span>(</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">station =</span> <span class="st">"PHL"</span>,  <span class="co"># Philadelphia International Airport</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_start =</span> <span class="st">"2025-04-01"</span>,</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_end =</span> <span class="st">"2025-06-30"</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Process weather data</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>weather_processed <span class="ot">&lt;-</span> weather_data <span class="sc">%&gt;%</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">interval60 =</span> <span class="fu">floor_date</span>(valid, <span class="at">unit =</span> <span class="st">"hour"</span>),</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Temperature =</span> tmpf,  <span class="co"># Temperature in Fahrenheit</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Precipitation =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(p01i), <span class="dv">0</span>, p01i),  <span class="co"># Hourly precip in inches</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Wind_Speed =</span> sknt  <span class="co"># Wind speed in knots</span></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(interval60, Temperature, Precipitation, Wind_Speed) <span class="sc">%&gt;%</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing hours and interpolate if needed</span></span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>weather_complete <span class="ot">&lt;-</span> weather_processed <span class="sc">%&gt;%</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">interval60 =</span> <span class="fu">seq</span>(<span class="fu">min</span>(interval60), <span class="fu">max</span>(interval60), <span class="at">by =</span> <span class="st">"hour"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(Temperature, Precipitation, Wind_Speed, <span class="at">.direction =</span> <span class="st">"down"</span>)</span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the weather</span></span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(weather_complete <span class="sc">%&gt;%</span> <span class="fu">select</span>(Temperature, Precipitation, Wind_Speed))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Temperature     Precipitation       Wind_Speed    
 Min.   : 33.00   Min.   :0.00000   Min.   : 0.000  
 1st Qu.: 57.00   1st Qu.:0.00000   1st Qu.: 5.000  
 Median : 65.00   Median :0.00000   Median : 8.000  
 Mean   : 64.69   Mean   :0.01121   Mean   : 8.103  
 3rd Qu.: 72.00   3rd Qu.:0.00010   3rd Qu.:10.000  
 Max.   :100.00   Max.   :1.14000   Max.   :40.000  </code></pre>
</div>
</div>
<section id="visualize-weather-patterns-1" class="level2">
<h2 class="anchored" data-anchor-id="visualize-weather-patterns-1">Visualize Weather Patterns</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weather_complete, <span class="fu">aes</span>(<span class="at">x =</span> interval60, <span class="at">y =</span> Temperature)) <span class="sc">+</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#3182bd"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Philadelphia Temperature - Q2 2025"</span>,</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Winter to early spring transition"</span>,</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Temperature (°F)"</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/visualize_weather2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="create-space-time-panel-1" class="level1">
<h1>Create Space-Time Panel</h1>
<section id="aggregate-trips-to-station-hour-level-1" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-trips-to-station-hour-level-1">Aggregate Trips to Station-Hour Level</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count trips by station-hour</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>trips_panel <span class="ot">&lt;-</span> indego_census <span class="sc">%&gt;%</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(interval60, start_station, start_lat, start_lon,</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>           Med_Inc, Percent_Taking_Transit, Percent_White, Total_Pop) <span class="sc">%&gt;%</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Trip_Count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="co"># How many station-hour observations?</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(trips_panel)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 179107</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many unique stations?</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>start_station))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 252</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many unique hours?</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>interval60))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2177</code></pre>
</div>
</div>
</section>
<section id="create-complete-panel-structure-1" class="level2">
<h2 class="anchored" data-anchor-id="create-complete-panel-structure-1">Create Complete Panel Structure</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate expected panel size</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>n_stations <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>start_station))</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>n_hours <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>interval60))</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>expected_rows <span class="ot">&lt;-</span> n_stations <span class="sc">*</span> n_hours</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Expected panel rows:"</span>, <span class="fu">format</span>(expected_rows, <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Expected panel rows: 548,604 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Current rows:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(trips_panel), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Current rows: 179,107 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Missing rows:"</span>, <span class="fu">format</span>(expected_rows <span class="sc">-</span> <span class="fu">nrow</span>(trips_panel), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Missing rows: 369,497 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create complete panel</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">interval60 =</span> <span class="fu">unique</span>(trips_panel<span class="sc">$</span>interval60),</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_station =</span> <span class="fu">unique</span>(trips_panel<span class="sc">$</span>start_station)</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join trip counts</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(trips_panel, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"interval60"</span>, <span class="st">"start_station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replace NA trip counts with 0</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Trip_Count =</span> <span class="fu">replace_na</span>(Trip_Count, <span class="dv">0</span>))</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill in station attributes (they're the same for all hours)</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>station_attributes <span class="ot">&lt;-</span> trips_panel <span class="sc">%&gt;%</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_lat =</span> <span class="fu">first</span>(start_lat),</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_lon =</span> <span class="fu">first</span>(start_lon),</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Med_Inc =</span> <span class="fu">first</span>(Med_Inc),</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_Taking_Transit =</span> <span class="fu">first</span>(Percent_Taking_Transit),</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_White =</span> <span class="fu">first</span>(Percent_White),</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Pop =</span> <span class="fu">first</span>(Total_Pop)</span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_attributes, <span class="at">by =</span> <span class="st">"start_station"</span>)</span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify we have complete panel</span></span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Complete panel rows:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(study_panel), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Complete panel rows: 548,604 </code></pre>
</div>
</div>
</section>
<section id="add-time-features-1" class="level2">
<h2 class="anchored" data-anchor-id="add-time-features-1">Add Time Features</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">week =</span> <span class="fu">week</span>(interval60),</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">dotw =</span> <span class="fu">wday</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">hour =</span> <span class="fu">hour</span>(interval60),</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(interval60),</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekend =</span> <span class="fu">ifelse</span>(dotw <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">rush_hour =</span> <span class="fu">ifelse</span>(hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="join-weather-data-1" class="level2">
<h2 class="anchored" data-anchor-id="join-weather-data-1">Join Weather Data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(weather_complete, <span class="at">by =</span> <span class="st">"interval60"</span>)</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing values</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(study_panel <span class="sc">%&gt;%</span> <span class="fu">select</span>(Trip_Count, Temperature, Precipitation))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Trip_Count       Temperature    Precipitation   
 Min.   : 0.0000   Min.   : 33.0   Min.   :0.0000  
 1st Qu.: 0.0000   1st Qu.: 57.0   1st Qu.:0.0000  
 Median : 0.0000   Median : 65.0   Median :0.0000  
 Mean   : 0.6055   Mean   : 64.7   Mean   :0.0111  
 3rd Qu.: 1.0000   3rd Qu.: 72.0   3rd Qu.:0.0001  
 Max.   :27.0000   Max.   :100.0   Max.   :1.1400  
                   NA's   :6048    NA's   :6048    </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="create-temporal-lag-variables-1" class="level1">
<h1>Create Temporal Lag Variables</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by station and time</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(start_station, interval60)</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create lag variables WITHIN each station</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag1Hour =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">1</span>),</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag2Hours =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">2</span>),</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag3Hours =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">3</span>),</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag12Hours =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">12</span>),</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag1day =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">24</span>)</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows with NA lags (first 24 hours for each station)</span></span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>study_panel_complete <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lag1day))</span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows after removing NA lags:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(study_panel_complete), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows after removing NA lags: 727,776 </code></pre>
</div>
</div>
<section id="visualize-lag-correlations-1" class="level2">
<h2 class="anchored" data-anchor-id="visualize-lag-correlations-1">Visualize Lag Correlations</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample one station to visualize</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>example_station <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(start_station <span class="sc">==</span> <span class="fu">first</span>(start_station)) <span class="sc">%&gt;%</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">168</span>)  <span class="co"># One week</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot actual vs lagged demand</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(example_station, <span class="fu">aes</span>(<span class="at">x =</span> interval60)) <span class="sc">+</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Trip_Count, <span class="at">color =</span> <span class="st">"Current"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> lag1Hour, <span class="at">color =</span> <span class="st">"1 Hour Ago"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> lag1day, <span class="at">color =</span> <span class="st">"24 Hours Ago"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Current"</span> <span class="ot">=</span> <span class="st">"#08519c"</span>,</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1 Hour Ago"</span> <span class="ot">=</span> <span class="st">"#3182bd"</span>,</span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"24 Hours Ago"</span> <span class="ot">=</span> <span class="st">"#6baed6"</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Temporal Lag Patterns at One Station"</span>,</span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Past demand predicts future demand"</span>,</span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date-Time"</span>,</span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Trip Count"</span>,</span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Time Period"</span></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/lag_correlations2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="temporal-traintest-split-1" class="level1">
<h1>Temporal Train/Test Split</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split by week</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Q1 has weeks 14-26 (April-June)</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Train on weeks 14-23 (Apr 1 - early June)</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test on weeks 23-26 (rest of June)</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Which stations have trips in BOTH early and late periods?</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>early_stations <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&lt;</span> <span class="dv">23</span>) <span class="sc">%&gt;%</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trip_Count <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(start_station)</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>late_stations <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&gt;=</span> <span class="dv">23</span>) <span class="sc">%&gt;%</span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trip_Count <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(start_station)</span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only stations that appear in BOTH periods</span></span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a>common_stations <span class="ot">&lt;-</span> <span class="fu">intersect</span>(early_stations, late_stations)</span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter panel to only common stations</span></span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true" tabindex="-1"></a>study_panel_complete <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb132-25"><a href="#cb132-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(start_station <span class="sc">%in%</span> common_stations)</span>
<span id="cb132-26"><a href="#cb132-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-27"><a href="#cb132-27" aria-hidden="true" tabindex="-1"></a><span class="co"># NOW create train/test split</span></span>
<span id="cb132-28"><a href="#cb132-28" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb132-29"><a href="#cb132-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&lt;</span> <span class="dv">23</span>)</span>
<span id="cb132-30"><a href="#cb132-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-31"><a href="#cb132-31" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb132-32"><a href="#cb132-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&gt;=</span> <span class="dv">23</span>)</span>
<span id="cb132-33"><a href="#cb132-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-34"><a href="#cb132-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Training observations:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(train), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Training observations: 498,747 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing observations:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(test), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Testing observations: 220,365 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Training date range:"</span>, <span class="fu">min</span>(train<span class="sc">$</span>date), <span class="st">"to"</span>, <span class="fu">max</span>(train<span class="sc">$</span>date), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Training date range: 20179 to 20242 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing date range:"</span>, <span class="fu">min</span>(test<span class="sc">$</span>date), <span class="st">"to"</span>, <span class="fu">max</span>(test<span class="sc">$</span>date), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Testing date range: 20243 to 20269 </code></pre>
</div>
</div>
<hr>
</section>
<section id="build-predictive-models-1" class="level1">
<h1>Build Predictive Models</h1>
<p>We’ll build 5 models with increasing complexity to see what improves predictions.</p>
<section id="model-1-baseline-time-weather-1" class="level2">
<h2 class="anchored" data-anchor-id="model-1-baseline-time-weather-1">Model 1: Baseline (Time + Weather)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create day of week factor with treatment (dummy) coding</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> train <span class="sc">%&gt;%</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dotw_simple =</span> <span class="fu">factor</span>(dotw, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>, <span class="st">"Sat"</span>, <span class="st">"Sun"</span>)))</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set contrasts to treatment coding (dummy variables)</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(train<span class="sc">$</span>dotw_simple) <span class="ot">&lt;-</span> <span class="fu">contr.treatment</span>(<span class="dv">7</span>)</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Now run the model</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation,</span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation, data = train)

Residuals:
    Min      1Q  Median      3Q     Max 
-1.5973 -0.6602 -0.2101  0.2056 25.5474 

Coefficients:
                    Estimate Std. Error t value             Pr(&gt;|t|)    
(Intercept)       -0.6377352  0.0135543 -47.050 &lt; 0.0000000000000002 ***
as.factor(hour)1  -0.0411708  0.0110414  -3.729             0.000192 ***
as.factor(hour)2  -0.0639198  0.0111100  -5.753   0.0000000087548969 ***
as.factor(hour)3  -0.1045973  0.0111883  -9.349 &lt; 0.0000000000000002 ***
as.factor(hour)4  -0.0857670  0.0111916  -7.664   0.0000000000000181 ***
as.factor(hour)5   0.0136237  0.0110296   1.235             0.216759    
as.factor(hour)6   0.2345878  0.0112929  20.773 &lt; 0.0000000000000002 ***
as.factor(hour)7   0.4903620  0.0110199  44.498 &lt; 0.0000000000000002 ***
as.factor(hour)8   0.8226332  0.0109747  74.957 &lt; 0.0000000000000002 ***
as.factor(hour)9   0.6066977  0.0109072  55.624 &lt; 0.0000000000000002 ***
as.factor(hour)10  0.4822213  0.0109270  44.131 &lt; 0.0000000000000002 ***
as.factor(hour)11  0.5251388  0.0107154  49.008 &lt; 0.0000000000000002 ***
as.factor(hour)12  0.5449794  0.0108905  50.042 &lt; 0.0000000000000002 ***
as.factor(hour)13  0.5447782  0.0107258  50.791 &lt; 0.0000000000000002 ***
as.factor(hour)14  0.5785329  0.0106672  54.235 &lt; 0.0000000000000002 ***
as.factor(hour)15  0.6899547  0.0107275  64.317 &lt; 0.0000000000000002 ***
as.factor(hour)16  0.8418613  0.0107744  78.136 &lt; 0.0000000000000002 ***
as.factor(hour)17  1.1067064  0.0106875 103.552 &lt; 0.0000000000000002 ***
as.factor(hour)18  0.8956767  0.0110737  80.883 &lt; 0.0000000000000002 ***
as.factor(hour)19  0.6214480  0.0108481  57.286 &lt; 0.0000000000000002 ***
as.factor(hour)20  0.3792801  0.0110807  34.229 &lt; 0.0000000000000002 ***
as.factor(hour)21  0.2415679  0.0110556  21.850 &lt; 0.0000000000000002 ***
as.factor(hour)22  0.1619637  0.0113139  14.315 &lt; 0.0000000000000002 ***
as.factor(hour)23  0.0797368  0.0108465   7.351   0.0000000000001964 ***
dotw_simple2       0.0447468  0.0060084   7.447   0.0000000000000954 ***
dotw_simple3      -0.0390441  0.0059647  -6.546   0.0000000000592243 ***
dotw_simple4       0.0367432  0.0058631   6.267   0.0000000003686729 ***
dotw_simple5      -0.0190780  0.0058151  -3.281             0.001035 ** 
dotw_simple6      -0.0395519  0.0060522  -6.535   0.0000000000636339 ***
dotw_simple7      -0.0593200  0.0062383  -9.509 &lt; 0.0000000000000002 ***
Temperature        0.0135446  0.0001686  80.354 &lt; 0.0000000000000002 ***
Precipitation     -0.0830165  0.0215151  -3.859             0.000114 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.104 on 498715 degrees of freedom
Multiple R-squared:  0.108, Adjusted R-squared:  0.1079 
F-statistic:  1947 on 31 and 498715 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
</section>
<section id="model-2-add-temporal-lags-1" class="level2">
<h2 class="anchored" data-anchor-id="model-2-add-temporal-lags-1">Model 2: Add Temporal Lags</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day,</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation + lag1Hour + lag3Hours + lag1day, data = train)

Residuals:
     Min       1Q   Median       3Q      Max 
-11.7651  -0.4068  -0.1187   0.1067  20.1518 

Coefficients:
                    Estimate Std. Error t value             Pr(&gt;|t|)    
(Intercept)       -0.2468884  0.0115469 -21.381 &lt; 0.0000000000000002 ***
as.factor(hour)1  -0.0134365  0.0093749  -1.433             0.151789    
as.factor(hour)2  -0.0040216  0.0094359  -0.426             0.669962    
as.factor(hour)3  -0.0300068  0.0095050  -3.157             0.001594 ** 
as.factor(hour)4  -0.0126009  0.0095152  -1.324             0.185410    
as.factor(hour)5   0.0673110  0.0093788   7.177    0.000000000000714 ***
as.factor(hour)6   0.2357904  0.0096053  24.548 &lt; 0.0000000000000002 ***
as.factor(hour)7   0.3775938  0.0093781  40.263 &lt; 0.0000000000000002 ***
as.factor(hour)8   0.5690617  0.0093518  60.851 &lt; 0.0000000000000002 ***
as.factor(hour)9   0.2389521  0.0093037  25.684 &lt; 0.0000000000000002 ***
as.factor(hour)10  0.1833591  0.0093034  19.709 &lt; 0.0000000000000002 ***
as.factor(hour)11  0.2430645  0.0091259  26.635 &lt; 0.0000000000000002 ***
as.factor(hour)12  0.2813190  0.0092694  30.349 &lt; 0.0000000000000002 ***
as.factor(hour)13  0.2944059  0.0091260  32.260 &lt; 0.0000000000000002 ***
as.factor(hour)14  0.3142945  0.0090776  34.623 &lt; 0.0000000000000002 ***
as.factor(hour)15  0.3951557  0.0091321  43.271 &lt; 0.0000000000000002 ***
as.factor(hour)16  0.4930111  0.0091816  53.695 &lt; 0.0000000000000002 ***
as.factor(hour)17  0.6811937  0.0091256  74.647 &lt; 0.0000000000000002 ***
as.factor(hour)18  0.3717998  0.0094783  39.227 &lt; 0.0000000000000002 ***
as.factor(hour)19  0.2065849  0.0092634  22.301 &lt; 0.0000000000000002 ***
as.factor(hour)20  0.0622124  0.0094515   6.582    0.000000000046375 ***
as.factor(hour)21  0.0511982  0.0094059   5.443    0.000000052351743 ***
as.factor(hour)22  0.0461062  0.0096124   4.797    0.000001614798692 ***
as.factor(hour)23  0.0272482  0.0092090   2.959             0.003088 ** 
dotw_simple2       0.0195096  0.0051011   3.825             0.000131 ***
dotw_simple3      -0.0345530  0.0050665  -6.820    0.000000000009121 ***
dotw_simple4       0.0214327  0.0049775   4.306    0.000016632428861 ***
dotw_simple5      -0.0122444  0.0049371  -2.480             0.013136 *  
dotw_simple6      -0.0215405  0.0051397  -4.191    0.000027780809914 ***
dotw_simple7      -0.0388226  0.0052980  -7.328    0.000000000000234 ***
Temperature        0.0038062  0.0001452  26.215 &lt; 0.0000000000000002 ***
Precipitation     -0.1105215  0.0182675  -6.050    0.000000001448012 ***
lag1Hour           0.4196719  0.0013114 320.017 &lt; 0.0000000000000002 ***
lag3Hours          0.1219574  0.0012950  94.173 &lt; 0.0000000000000002 ***
lag1day            0.1301294  0.0011988 108.550 &lt; 0.0000000000000002 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.9374 on 498712 degrees of freedom
Multiple R-squared:  0.3571,    Adjusted R-squared:  0.3571 
F-statistic:  8149 on 34 and 498712 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
</section>
<section id="model-3-add-demographics-1" class="level2">
<h2 class="anchored" data-anchor-id="model-3-add-demographics-1">Model 3: Add Demographics</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day <span class="sc">+</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    Med_Inc.x <span class="sc">+</span> Percent_Taking_Transit.y <span class="sc">+</span> Percent_White.y,</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model3)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation + lag1Hour + lag3Hours + lag1day + Med_Inc.x + 
    Percent_Taking_Transit.y + Percent_White.y, data = train)

Residuals:
    Min      1Q  Median      3Q     Max 
-7.2209 -0.6616 -0.2563  0.4035 20.4632 

Coefficients:
                              Estimate    Std. Error t value
(Intercept)               0.4406970415  0.0363319876  12.130
as.factor(hour)1          0.0496543983  0.0387077576   1.283
as.factor(hour)2          0.0557316649  0.0413301325   1.348
as.factor(hour)3         -0.0854994429  0.0526259771  -1.625
as.factor(hour)4         -0.0506592117  0.0502917111  -1.007
as.factor(hour)5          0.0249121749  0.0351554261   0.709
as.factor(hour)6          0.3080255762  0.0306174303  10.060
as.factor(hour)7          0.4102664374  0.0283084868  14.493
as.factor(hour)8          0.6237282228  0.0273206080  22.830
as.factor(hour)9          0.1229538278  0.0274924099   4.472
as.factor(hour)10         0.1089465034  0.0278635955   3.910
as.factor(hour)11         0.1415417179  0.0273330360   5.178
as.factor(hour)12         0.2058031351  0.0274404196   7.500
as.factor(hour)13         0.2423025788  0.0272442395   8.894
as.factor(hour)14         0.1998194065  0.0269288510   7.420
as.factor(hour)15         0.3146303978  0.0268079668  11.736
as.factor(hour)16         0.4608457292  0.0267343133  17.238
as.factor(hour)17         0.7033251763  0.0264420906  26.599
as.factor(hour)18         0.2792961266  0.0269051672  10.381
as.factor(hour)19         0.0955337184  0.0270520220   3.531
as.factor(hour)20        -0.0243192000  0.0279745479  -0.869
as.factor(hour)21        -0.0248597751  0.0287195075  -0.866
as.factor(hour)22        -0.0135141145  0.0298326902  -0.453
as.factor(hour)23        -0.0034317764  0.0304173530  -0.113
dotw_simple2              0.0323640406  0.0114869781   2.817
dotw_simple3             -0.0598277266  0.0118480871  -5.050
dotw_simple4             -0.0088472033  0.0113540073  -0.779
dotw_simple5             -0.0690814729  0.0112102533  -6.162
dotw_simple6              0.0356817125  0.0119532435   2.985
dotw_simple7              0.0059532202  0.0123577029   0.482
Temperature               0.0074256468  0.0003481431  21.329
Precipitation            -0.3450355405  0.0361701753  -9.539
lag1Hour                  0.3101259828  0.0021643730 143.287
lag3Hours                 0.0882016341  0.0022259445  39.624
lag1day                   0.1149544429  0.0021229555  54.148
Med_Inc.x                 0.0000002947  0.0000001086   2.714
Percent_Taking_Transit.y -0.0040106436  0.0004076555  -9.838
Percent_White.y           0.0025740005  0.0002007487  12.822
                                     Pr(&gt;|t|)    
(Intercept)              &lt; 0.0000000000000002 ***
as.factor(hour)1                     0.199563    
as.factor(hour)2                     0.177515    
as.factor(hour)3                     0.104237    
as.factor(hour)4                     0.313789    
as.factor(hour)5                     0.478555    
as.factor(hour)6         &lt; 0.0000000000000002 ***
as.factor(hour)7         &lt; 0.0000000000000002 ***
as.factor(hour)8         &lt; 0.0000000000000002 ***
as.factor(hour)9           0.0000077443208911 ***
as.factor(hour)10          0.0000923370105501 ***
as.factor(hour)11          0.0000002240580230 ***
as.factor(hour)12          0.0000000000000642 ***
as.factor(hour)13        &lt; 0.0000000000000002 ***
as.factor(hour)14          0.0000000000001175 ***
as.factor(hour)15        &lt; 0.0000000000000002 ***
as.factor(hour)16        &lt; 0.0000000000000002 ***
as.factor(hour)17        &lt; 0.0000000000000002 ***
as.factor(hour)18        &lt; 0.0000000000000002 ***
as.factor(hour)19                    0.000413 ***
as.factor(hour)20                    0.384666    
as.factor(hour)21                    0.386708    
as.factor(hour)22                    0.650552    
as.factor(hour)23                    0.910171    
dotw_simple2                         0.004841 ** 
dotw_simple3               0.0000004433034819 ***
dotw_simple4                         0.435855    
dotw_simple5               0.0000000007184786 ***
dotw_simple6                         0.002835 ** 
dotw_simple7                         0.629990    
Temperature              &lt; 0.0000000000000002 ***
Precipitation            &lt; 0.0000000000000002 ***
lag1Hour                 &lt; 0.0000000000000002 ***
lag3Hours                &lt; 0.0000000000000002 ***
lag1day                  &lt; 0.0000000000000002 ***
Med_Inc.x                            0.006652 ** 
Percent_Taking_Transit.y &lt; 0.0000000000000002 ***
Percent_White.y          &lt; 0.0000000000000002 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.211 on 156977 degrees of freedom
  (341732 observations deleted due to missingness)
Multiple R-squared:  0.2487,    Adjusted R-squared:  0.2486 
F-statistic:  1405 on 37 and 156977 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
</section>
<section id="model-4-add-station-fixed-effects-1" class="level2">
<h2 class="anchored" data-anchor-id="model-4-add-station-fixed-effects-1">Model 4: Add Station Fixed Effects</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day <span class="sc">+</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    Med_Inc.x <span class="sc">+</span> Percent_Taking_Transit.y <span class="sc">+</span> Percent_White.y <span class="sc">+</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(start_station),</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary too long with all station dummies, just show key metrics</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 4 R-squared:"</span>, <span class="fu">summary</span>(model4)<span class="sc">$</span>r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 4 R-squared: 0.2718325 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 4 Adj R-squared:"</span>, <span class="fu">summary</span>(model4)<span class="sc">$</span>adj.r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 4 Adj R-squared: 0.2705223 </code></pre>
</div>
</div>
</section>
<section id="model-5-add-rush-hour-interaction-1" class="level2">
<h2 class="anchored" data-anchor-id="model-5-add-rush-hour-interaction-1">Model 5: Add Rush Hour Interaction</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>model5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day <span class="sc">+</span> rush_hour <span class="sc">+</span> <span class="fu">as.factor</span>(month) <span class="sc">+</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>    Med_Inc.x <span class="sc">+</span> Percent_Taking_Transit.y <span class="sc">+</span> Percent_White.y <span class="sc">+</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(start_station) <span class="sc">+</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>    rush_hour <span class="sc">*</span> weekend,  <span class="co"># Rush hour effects different on weekends</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 5 R-squared:"</span>, <span class="fu">summary</span>(model5)<span class="sc">$</span>r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 5 R-squared: 0.2759937 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 5 Adj R-squared:"</span>, <span class="fu">summary</span>(model5)<span class="sc">$</span>adj.r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 5 Adj R-squared: 0.2746771 </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="model-evaluation-1" class="level1">
<h1>Model Evaluation</h1>
<section id="calculate-predictions-and-mae-1" class="level2">
<h2 class="anchored" data-anchor-id="calculate-predictions-and-mae-1">Calculate Predictions and MAE</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions on test set</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create day of week factor with treatment (dummy) coding</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dotw_simple =</span> <span class="fu">factor</span>(dotw, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>, <span class="st">"Sat"</span>, <span class="st">"Sun"</span>)))</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set contrasts to treatment coding (dummy variables)</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(test<span class="sc">$</span>dotw_simple) <span class="ot">&lt;-</span> <span class="fu">contr.treatment</span>(<span class="dv">7</span>)</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred1 =</span> <span class="fu">predict</span>(model1, <span class="at">newdata =</span> test),</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred2 =</span> <span class="fu">predict</span>(model2, <span class="at">newdata =</span> test),</span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred3 =</span> <span class="fu">predict</span>(model3, <span class="at">newdata =</span> test),</span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred4 =</span> <span class="fu">predict</span>(model4, <span class="at">newdata =</span> test),</span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred5 =</span> <span class="fu">predict</span>(model5, <span class="at">newdata =</span> test)</span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate MAE for each model</span></span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a>mae_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(</span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1. Time + Weather"</span>,</span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2. + Temporal Lags"</span>,</span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"3. + Demographics"</span>,</span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4. + Station FE"</span>,</span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5. + Rush Hour Interaction"</span></span>
<span id="cb154-27"><a href="#cb154-27" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb154-28"><a href="#cb154-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE =</span> <span class="fu">c</span>(</span>
<span id="cb154-29"><a href="#cb154-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred1), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb154-30"><a href="#cb154-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred2), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb154-31"><a href="#cb154-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred3), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb154-32"><a href="#cb154-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred4), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb154-33"><a href="#cb154-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred5), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb154-34"><a href="#cb154-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb154-35"><a href="#cb154-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb154-36"><a href="#cb154-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-37"><a href="#cb154-37" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(mae_results, </span>
<span id="cb154-38"><a href="#cb154-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">digits =</span> <span class="dv">2</span>,</span>
<span id="cb154-39"><a href="#cb154-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Mean Absolute Error by Model (Test Set)"</span>,</span>
<span id="cb154-40"><a href="#cb154-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"MAE (trips)"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb154-41"><a href="#cb154-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small">
<caption>Mean Absolute Error by Model (Test Set)</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MAE (trips)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1. Time + Weather</td>
<td style="text-align: right;">0.82</td>
</tr>
<tr class="even">
<td style="text-align: left;">2. + Temporal Lags</td>
<td style="text-align: right;">0.62</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3. + Demographics</td>
<td style="text-align: right;">0.86</td>
</tr>
<tr class="even">
<td style="text-align: left;">4. + Station FE</td>
<td style="text-align: right;">0.86</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5. + Rush Hour Interaction</td>
<td style="text-align: right;">0.90</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="visualize-model-comparison-1" class="level2">
<h2 class="anchored" data-anchor-id="visualize-model-comparison-1">Visualize Model Comparison</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mae_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Model, <span class="sc">-</span>MAE), <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"#3182bd"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(MAE, <span class="dv">2</span>)), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Performance Comparison"</span>,</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Lower MAE = Better Predictions"</span>,</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Model"</span>,</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean Absolute Error (trips)"</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>  plotTheme <span class="sc">+</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/compare_models-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
<p><strong>Compare results</strong> to Q1 2025:</p>
<ul>
<li>How do MAE values compare? Why might they differ?</li>
<li>Are temporal patterns different (e.g., summer vs.&nbsp;winter)?</li>
<li>Which features are most important in your quarter?</li>
</ul>
<p>The 2025 Q2 MAE values are larger across all time periods, which most likely can be attributed to the larger amount of cyclists during this period (slightly more than 36k vs slightly more than 20k). The better weather definitely has something to do with this, as it invites less bike-dependent/craved individuals to use Indego. These additional casual cyclists are less predictable or stable.</p>
</section>
<section id="part-2-error-analysis" class="level2">
<h2 class="anchored" data-anchor-id="part-2-error-analysis">Part 2: Error Analysis</h2>
<p>Analyze your model’s errors in detail:</p>
</section>
</section>
<section id="space-time-error-analysis-1" class="level1">
<h1>Space-Time Error Analysis</h1>
<section id="observed-vs.-predicted-1" class="level2">
<h2 class="anchored" data-anchor-id="observed-vs.-predicted-1">Observed vs.&nbsp;Predicted</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> Trip_Count <span class="sc">-</span> pred2,</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_error =</span> <span class="fu">abs</span>(error),</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_of_day =</span> <span class="fu">case_when</span>(</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&lt;</span> <span class="dv">7</span> <span class="sc">~</span> <span class="st">"Overnight"</span>,</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;=</span> <span class="dv">7</span> <span class="sc">&amp;</span> hour <span class="sc">&lt;</span> <span class="dv">10</span> <span class="sc">~</span> <span class="st">"AM Rush"</span>,</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;=</span> <span class="dv">10</span> <span class="sc">&amp;</span> hour <span class="sc">&lt;</span> <span class="dv">15</span> <span class="sc">~</span> <span class="st">"Mid-Day"</span>,</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;=</span> <span class="dv">15</span> <span class="sc">&amp;</span> hour <span class="sc">&lt;=</span> <span class="dv">18</span> <span class="sc">~</span> <span class="st">"PM Rush"</span>,</span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;</span> <span class="dv">18</span> <span class="sc">~</span> <span class="st">"Evening"</span></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot by time and day type</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test, <span class="fu">aes</span>(<span class="at">x =</span> Trip_Count, <span class="at">y =</span> pred2)) <span class="sc">+</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(weekend <span class="sc">~</span> time_of_day) <span class="sc">+</span></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Observed vs. Predicted Bike Trips"</span>,</span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Model 2 performance by time period"</span>,</span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Observed Trips"</span>,</span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Trips"</span>,</span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Red line = perfect predictions; Green line = actual model fit"</span></span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/obs_vs_pred2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="spatial-error-patterns-1" class="level2">
<h2 class="anchored" data-anchor-id="spatial-error-patterns-1">Spatial Error Patterns</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate MAE by station</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>station_errors <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station, start_lat.x, start_lon.y) <span class="sc">%&gt;%</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(abs_error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_demand =</span> <span class="fu">mean</span>(Trip_Count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat.x), <span class="sc">!</span><span class="fu">is.na</span>(start_lon.y))</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Create Two Maps Side-by-Side with Proper Legends (sorry these maps are ugly)</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate station errors</span></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>station_errors <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred2)) <span class="sc">%&gt;%</span></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station, start_lat.x, start_lon.y) <span class="sc">%&gt;%</span></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(Trip_Count <span class="sc">-</span> pred2), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_demand =</span> <span class="fu">mean</span>(Trip_Count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat.x), <span class="sc">!</span><span class="fu">is.na</span>(start_lon.y))</span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 1: Prediction Errors</span></span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb157-27"><a href="#cb157-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb157-28"><a href="#cb157-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb157-29"><a href="#cb157-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> MAE),</span>
<span id="cb157-30"><a href="#cb157-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb157-31"><a href="#cb157-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb157-32"><a href="#cb157-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-33"><a href="#cb157-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb157-34"><a href="#cb157-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"plasma"</span>,</span>
<span id="cb157-35"><a href="#cb157-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"MAE</span><span class="sc">\n</span><span class="st">(trips)"</span>,</span>
<span id="cb157-36"><a href="#cb157-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb157-37"><a href="#cb157-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>),  <span class="co"># Fewer, cleaner breaks</span></span>
<span id="cb157-38"><a href="#cb157-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>)</span>
<span id="cb157-39"><a href="#cb157-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-40"><a href="#cb157-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prediction Errors"</span>,</span>
<span id="cb157-41"><a href="#cb157-41" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Higher in Center City"</span>) <span class="sc">+</span></span>
<span id="cb157-42"><a href="#cb157-42" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb157-43"><a href="#cb157-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb157-44"><a href="#cb157-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb157-45"><a href="#cb157-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb157-46"><a href="#cb157-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb157-47"><a href="#cb157-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb157-48"><a href="#cb157-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb157-49"><a href="#cb157-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-50"><a href="#cb157-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb157-51"><a href="#cb157-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="fl">1.5</span>,</span>
<span id="cb157-52"><a href="#cb157-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">12</span>,</span>
<span id="cb157-53"><a href="#cb157-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb157-54"><a href="#cb157-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb157-55"><a href="#cb157-55" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb157-56"><a href="#cb157-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-57"><a href="#cb157-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 2: Average Demand</span></span>
<span id="cb157-58"><a href="#cb157-58" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb157-59"><a href="#cb157-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb157-60"><a href="#cb157-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb157-61"><a href="#cb157-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb157-62"><a href="#cb157-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> avg_demand),</span>
<span id="cb157-63"><a href="#cb157-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb157-64"><a href="#cb157-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb157-65"><a href="#cb157-65" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-66"><a href="#cb157-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb157-67"><a href="#cb157-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb157-68"><a href="#cb157-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Avg</span><span class="sc">\n</span><span class="st">Demand"</span>,</span>
<span id="cb157-69"><a href="#cb157-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb157-70"><a href="#cb157-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.0</span>, <span class="fl">2.5</span>),  <span class="co"># Clear breaks</span></span>
<span id="cb157-71"><a href="#cb157-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>, <span class="st">"2.0"</span>, <span class="st">"2.5"</span>)</span>
<span id="cb157-72"><a href="#cb157-72" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-73"><a href="#cb157-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Average Demand"</span>,</span>
<span id="cb157-74"><a href="#cb157-74" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Trips per station-hour"</span>) <span class="sc">+</span></span>
<span id="cb157-75"><a href="#cb157-75" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb157-76"><a href="#cb157-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb157-77"><a href="#cb157-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb157-78"><a href="#cb157-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb157-79"><a href="#cb157-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb157-80"><a href="#cb157-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb157-81"><a href="#cb157-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb157-82"><a href="#cb157-82" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb157-83"><a href="#cb157-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb157-84"><a href="#cb157-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="fl">1.5</span>,</span>
<span id="cb157-85"><a href="#cb157-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">12</span>,</span>
<span id="cb157-86"><a href="#cb157-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb157-87"><a href="#cb157-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb157-88"><a href="#cb157-88" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb157-89"><a href="#cb157-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-90"><a href="#cb157-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine with better layout</span></span>
<span id="cb157-91"><a href="#cb157-91" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb157-92"><a href="#cb157-92" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grid)</span>
<span id="cb157-93"><a href="#cb157-93" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(</span>
<span id="cb157-94"><a href="#cb157-94" aria-hidden="true" tabindex="-1"></a>  p1, p2, </span>
<span id="cb157-95"><a href="#cb157-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">2</span>,</span>
<span id="cb157-96"><a href="#cb157-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">top =</span> <span class="fu">textGrob</span>(</span>
<span id="cb157-97"><a href="#cb157-97" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Model 2 Performance: Errors vs. Demand Patterns"</span>,</span>
<span id="cb157-98"><a href="#cb157-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">16</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>)</span>
<span id="cb157-99"><a href="#cb157-99" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb157-100"><a href="#cb157-100" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/spatial_errors2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 1: Prediction Errors</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> MAE),</span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"plasma"</span>,</span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"MAE (trips)"</span>,</span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>),</span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>)</span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prediction Errors"</span>) <span class="sc">+</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="dv">12</span>,</span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">1</span>,</span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb158-29"><a href="#cb158-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb158-30"><a href="#cb158-30" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb158-31"><a href="#cb158-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-32"><a href="#cb158-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 2: Average Demand  </span></span>
<span id="cb158-33"><a href="#cb158-33" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb158-34"><a href="#cb158-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb158-35"><a href="#cb158-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb158-36"><a href="#cb158-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb158-37"><a href="#cb158-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> avg_demand),</span>
<span id="cb158-38"><a href="#cb158-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb158-39"><a href="#cb158-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb158-40"><a href="#cb158-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb158-41"><a href="#cb158-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb158-42"><a href="#cb158-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb158-43"><a href="#cb158-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Avg Demand (trips/hour)"</span>,</span>
<span id="cb158-44"><a href="#cb158-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb158-45"><a href="#cb158-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.0</span>, <span class="fl">2.5</span>),</span>
<span id="cb158-46"><a href="#cb158-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>, <span class="st">"2.0"</span>, <span class="st">"2.5"</span>)</span>
<span id="cb158-47"><a href="#cb158-47" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb158-48"><a href="#cb158-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Average Demand"</span>) <span class="sc">+</span></span>
<span id="cb158-49"><a href="#cb158-49" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb158-50"><a href="#cb158-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb158-51"><a href="#cb158-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb158-52"><a href="#cb158-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb158-53"><a href="#cb158-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb158-54"><a href="#cb158-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb158-55"><a href="#cb158-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb158-56"><a href="#cb158-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb158-57"><a href="#cb158-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="dv">12</span>,</span>
<span id="cb158-58"><a href="#cb158-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">1</span>,</span>
<span id="cb158-59"><a href="#cb158-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb158-60"><a href="#cb158-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb158-61"><a href="#cb158-61" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb158-62"><a href="#cb158-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-63"><a href="#cb158-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine</span></span>
<span id="cb158-64"><a href="#cb158-64" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(</span>
<span id="cb158-65"><a href="#cb158-65" aria-hidden="true" tabindex="-1"></a>  p1, p2,</span>
<span id="cb158-66"><a href="#cb158-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb158-67"><a href="#cb158-67" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/spatial_errors2-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/spatial_errors2-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="temporal-error-patterns-1" class="level2">
<h2 class="anchored" data-anchor-id="temporal-error-patterns-1">Temporal Error Patterns</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MAE by time of day and day type</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>temporal_errors <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(time_of_day, weekend) <span class="sc">%&gt;%</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(abs_error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day_type =</span> <span class="fu">ifelse</span>(weekend <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>))</span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(temporal_errors, <span class="fu">aes</span>(<span class="at">x =</span> time_of_day, <span class="at">y =</span> MAE, <span class="at">fill =</span> day_type)) <span class="sc">+</span></span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> <span class="st">"#08519c"</span>, <span class="st">"Weekend"</span> <span class="ot">=</span> <span class="st">"#6baed6"</span>)) <span class="sc">+</span></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Errors by Time Period"</span>,</span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"When is the model struggling most?"</span>,</span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time of Day"</span>,</span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean Absolute Error (trips)"</span>,</span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Day Type"</span></span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>  plotTheme <span class="sc">+</span></span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/temporal_errors2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="errors-and-demographics-1" class="level2">
<h2 class="anchored" data-anchor-id="errors-and-demographics-1">Errors and Demographics</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join demographic data to station errors</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>station_errors_demo <span class="ot">&lt;-</span> station_errors <span class="sc">%&gt;%</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>    station_attributes <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_station, Med_Inc, Percent_Taking_Transit, Percent_White),</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Med_Inc))</span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create plots</span></span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(station_errors_demo, <span class="fu">aes</span>(<span class="at">x =</span> Med_Inc, <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Errors vs. Median Income"</span>, <span class="at">x =</span> <span class="st">"Median Income"</span>, <span class="at">y =</span> <span class="st">"MAE"</span>) <span class="sc">+</span></span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(station_errors_demo, <span class="fu">aes</span>(<span class="at">x =</span> Percent_Taking_Transit, <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb161-20"><a href="#cb161-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Errors vs. Transit Usage"</span>, <span class="at">x =</span> <span class="st">"% Taking Transit"</span>, <span class="at">y =</span> <span class="st">"MAE"</span>) <span class="sc">+</span></span>
<span id="cb161-21"><a href="#cb161-21" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb161-22"><a href="#cb161-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-23"><a href="#cb161-23" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(station_errors_demo, <span class="fu">aes</span>(<span class="at">x =</span> Percent_White, <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb161-24"><a href="#cb161-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb161-25"><a href="#cb161-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb161-26"><a href="#cb161-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Errors vs. Race"</span>, <span class="at">x =</span> <span class="st">"% White"</span>, <span class="at">y =</span> <span class="st">"MAE"</span>) <span class="sc">+</span></span>
<span id="cb161-27"><a href="#cb161-27" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb161-28"><a href="#cb161-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-29"><a href="#cb161-29" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, p3, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lab5_files/figure-html/errors_demographics2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol type="1">
<li><strong>Spatial patterns:</strong></li>
</ol>
<p>The highest average errors are once again mirroring the stations with the highest average demand, This is most likely because these areas are both commute and post-work destinations so the patterns are dependent on the work day. Furthermore, with work from home becoming ore popular, not every weekday can be classified equally.</p>
<ol start="2" type="1">
<li><strong>Temporal patterns:</strong></li>
</ol>
<p>The errors are highest during the am and pm rush hours during the weekdays. This is most likely because these times are when the most people are reliant on the Indego network. The high reliance in these times means that people in the densely commuted to areas of the city (which are populated with a plethora of Indego stations) may not always use the same station or a station at all (i.e.&nbsp;staying in center city for a work event, running errands to skip the evening or morning rush, etc.).</p>
<ol start="3" type="1">
<li><strong>Demographic patterns:</strong></li>
</ol>
<p>White, Wealthy, and/or transit-heavy communities are still the hardest to predict, which, as previously stated, is most likely due to the wide array of Indego stations accessible to those communities. Thus, the equity implications stems from the easier to predict minority and lower-income communities, as it is clear they are offered <em>and deserve</em> an equal ability to choose Indego stations. The lack of stations in these communities limits their ability to have options, use the system conveniently, and access the larger bicycle network.</p>
</section>
<section id="part-4-critical-reflection" class="level2">
<h2 class="anchored" data-anchor-id="part-4-critical-reflection">Part 4: Critical Reflection</h2>
<p>Write 1-2 paragraphs addressing:</p>
<ol type="1">
<li><strong>Operational implications:</strong>
<ul>
<li>Is your final MAE “good enough” for Indego to use?</li>
<li>When do prediction errors cause problems for rebalancing?</li>
<li>Would you recommend deploying this system? Under what conditions?</li>
</ul></li>
<li><strong>Equity considerations:</strong>
<ul>
<li>Do prediction errors disproportionately affect certain neighborhoods?</li>
<li>Could this system worsen existing disparities in bike access?</li>
<li>What safeguards would you recommend?</li>
</ul></li>
<li><strong>Model limitations:</strong>
<ul>
<li>What patterns is your model missing?</li>
<li>What assumptions might not hold in real deployment?</li>
<li>How would you improve this with more time/data?</li>
</ul></li>
</ol>
<p>I do not believe the final MAE is “<em>good enough</em>” for Indego. Although MAE always being below 1 seems good, it is important to remember the scale of the panel data: 1 hour. Being a trip off per hour on average is huge when considering some Indego stations have as little as 10 bikes docks. This is especially risky during high-usage times, where MAE can increase above 1 during the evening rush hour on weekdays. Furthermore, MAE tends to increase as it gets into areas that rely heavily on transit, are wealthier, and whiter, meaning areas such as center city (which might be the most important point in the Indego network due to it being a commuting hub) are even more likely to be wrong. The model is missing patterns of the school calendar. universities and high schools might have a lot of students use Indego to commute. Summer break and the outflow of students from Philadelphia may subvert the expected relation that increased temperature correlates to increased ridership. Thus, I would not consider this model ready for deployment. With more time, I would consider factoring in school calendars as well as proximity to bike lanes, as I believe feelings of safety are crucial for increased ridership.</p>
<hr>
</section>
</section>
<section id="submission-requirements" class="level1">
<h1>Submission Requirements</h1>
<section id="what-to-submit-per-team" class="level2">
<h2 class="anchored" data-anchor-id="what-to-submit-per-team">What to Submit (per team)</h2>
<ol type="1">
<li><p><strong>Rmd file</strong> with all your code (commented!)</p></li>
<li><p><strong>HTML output</strong> with results and visualizations</p></li>
<li><p><strong>Brief report</strong> summarizing (with supporting data &amp; visualization):</p>
<ul>
<li>Your quarter and why you chose it</li>
<li>Model comparison results</li>
<li>Error analysis insights</li>
<li>New features you added and why</li>
<li>Critical reflection on deployment</li>
</ul></li>
</ol>
</section>
<section id="tips-for-success" class="level2">
<h2 class="anchored" data-anchor-id="tips-for-success">Tips for Success</h2>
<ol type="1">
<li><strong>Start early</strong> - data download and processing takes time</li>
<li><strong>Work together</strong> - pair programming is your friend</li>
<li><strong>Test incrementally</strong> - don’t wait until the end to run code</li>
<li><strong>Document everything</strong> - explain your choices</li>
<li><strong>Be creative</strong> - the best features come from understanding Philly!</li>
<li><strong>Think critically</strong> - technical sophistication isn’t enough</li>
</ol>
<hr>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>